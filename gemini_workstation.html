<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACG Clima Service - Web App con AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/downloadjs@1.4.7"></script> 
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        ::placeholder { color: #C7C7CC; }
        input[type=number] { -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .section-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007AFF; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .attachment-item { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .attachment-preview { max-width: 60px; max-height: 60px; border-radius: 4px; }
        
        .dropzone {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .dropzone.dragover {
            background-color: #e9efff;
            border-color: #007AFF;
        }
        
        @media print {
            body, html {
                margin: 0;
                padding: 0;
                width: 100%;
                height: auto;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>

<body class="bg-[#F5F5F7]">

    <div id="status-overlay" class="fixed inset-0 bg-white bg-opacity-95 z-50 flex flex-col justify-center items-center transition-opacity duration-500 no-print">
        <div class="loader"></div>
        <p id="status-text" class="mt-4 text-lg font-semibold text-[#1D1D1F]">Connessione al backend in corso...</p>
        <p class="text-sm text-[#86868B]">L'avvio potrebbe richiedere fino a 2 minuti.</p>
    </div>

    <div id="app" class="flex flex-col md:flex-row h-screen w-screen no-print">

        <nav class="w-full md:w-72 bg-white border-r border-[#C6C6C8] flex flex-col shrink-0">
            <div class="p-6 border-b border-[#C6C6C8]">
                <h1 class="text-xl font-bold text-[#1D1D1F]">ACG Clima Service</h1>
                <p class="text-sm text-[#86868B]">Gestione Integrata con AI</p>
            </div>
            <div class="flex-grow p-4 space-y-2">
                <button data-section="anagrafica" class="menu-item flex items-center w-full text-left p-3 rounded-lg bg-[#007AFF] text-white">
                    <span class="mr-3">üìÑ</span>
                    <span class="font-semibold">Dati Anagrafici</span>
                </button>
                <button data-section="intervention" class="menu-item flex items-center w-full text-left p-3 rounded-lg text-[#1D1D1F] hover:bg-[#F2F2F7]">
                    <span class="mr-3">üîß</span>
                    <span class="font-semibold">Dettagli Intervento</span>
                </button>
                <button data-section="mpls" class="menu-item flex items-center w-full text-left p-3 rounded-lg text-[#1D1D1F] hover:bg-[#F2F2F7]">
                    <span class="mr-3">üí∞</span>
                    <span class="font-semibold">Preventivo MPLS</span>
                </button>
                <button data-section="finalize" class="menu-item flex items-center w-full text-left p-3 rounded-lg text-[#1D1D1F] hover:bg-[#F2F2F7]">
                    <span class="mr-3">‚úÖ</span>
                    <span class="font-semibold">Finalizza ed Esporta</span>
                </button>
                <!-- NUOVO PULSANTE ARCHIVIO -->
                <button data-section="archivio" class="menu-item flex items-center w-full text-left p-3 rounded-lg text-[#1D1D1F] hover:bg-[#F2F2F7]">
                    <span class="mr-3">üóÑÔ∏è</span>
                    <span class="font-semibold">Archivio</span>
                </button>
            </div>
            <div class="p-4 border-t border-[#C6C6C8]">
                <div id="status-label" class="text-sm text-center text-gray-500 mb-2">üìç Dati Anagrafici</div>
                <button id="export-project-btn" class="w-full bg-[#5856D6] text-white font-bold py-2 px-4 rounded-lg mb-2">üì• Esporta Progetto (JSON)</button>
                <input type="file" id="import-project-input" class="hidden" accept=".json">
                <label for="import-project-input" class="w-full text-center cursor-pointer bg-[#5856D6] text-white font-bold py-2 px-4 rounded-lg">üìÇ Importa Progetto (JSON)</label>
            </div>
        </nav>

        <main class="flex-grow overflow-y-auto p-4 md:p-8">
            <section id="anagrafica" class="section-content section-fade-in">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-2xl font-bold text-[#1D1D1F] mb-4">üìÑ Dati Anagrafici Cliente</h2>
                    <div class="bg-[#F2F2F7] p-4 rounded-lg mb-6">
                        <h3 class="font-semibold text-[#1D1D1F] mb-2">Importa da PDF Ticket</h3>
                        <div id="ticket-dropzone" class="dropzone bg-gray-50 hover:bg-gray-100">
                            <input type="file" id="pdf-ticket-input" class="hidden" accept=".pdf" disabled>
                            <label for="pdf-ticket-input" class="cursor-pointer">
                                <span class="text-2xl">üìÅ</span>
                                <p class="mt-2 text-sm text-gray-600">Trascina qui il file PDF del ticket o fai clic per selezionarlo.</p>
                                <p id="ticket-dropzone-label" class="text-xs text-red-500 mt-1">Caricamento disabilitato. Backend non pronto.</p>
                            </label>
                        </div>
                        <button id="clear-ticket-btn" class="w-full mt-2 bg-[#FF3B30] text-white font-bold py-2 px-4 rounded-lg">üßπ Pulisci Dati Cliente</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input data-sync="numero_ticket" id="numero_ticket" type="text" placeholder="Numero Ticket" class="bg-[#F2F2F7] p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none">
                        <input data-sync="data_apertura" id="data_apertura" type="date" placeholder="Data Apertura" class="bg-[#F2F2F7] p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none">
                        <input data-sync="cliente" id="cliente" type="text" placeholder="Cliente" class="bg-[#F2F2F7] p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none md:col-span-2">
                        <input data-sync="condominio" id="condominio" type="text" placeholder="Condominio" class="bg-[#F2F2F7] p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none md:col-span-2">
                        <input data-sync="indirizzo" id="indirizzo" type="text" placeholder="Indirizzo" class="bg-[#F2F2F7] p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none md:col-span-2">
                        <input data-sync="tipo_contratto" id="tipo_contratto" type="text" placeholder="Tipo Contratto" class="bg-[#F2F2F7] p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none">
                        <input data-sync="data_intervento_programmato" id="data_intervento_programmato" type="date" placeholder="Data Intervento Programmato" class="bg-[#F2F2F7] p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none">
                        <select data-sync="tecnico_anagrafica" id="tecnico_anagrafica" class="bg-[#F2F2F7] p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none">
                            <option value="">Seleziona Tecnico</option>
                            </select>
                        <input data-sync="urgenza" id="urgenza" type="text" placeholder="Livello Urgenza" class="bg-[#F2F2F7] p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none">
                    </div>
                    <textarea data-sync="note" id="note" placeholder="Note e Descrizione Guasto..." rows="4" class="w-full mt-4 bg-[#F2F2F7] p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none"></textarea>
                      <!-- GEMINI API BUTTON -->
                      <div class="mt-2 text-right">
                        <button id="diagnose-btn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">‚ú® Suggerisci Diagnosi (AI)</button>
                      </div>
                </div>
            </section>
            
            <section id="intervention" class="hidden section-content section-fade-in">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-2xl font-bold text-[#1D1D1F] mb-4">üîß Rapporto Tecnico di Intervento (RTI)</h2>
                    
                    <div class="bg-[#F2F2F7] p-4 rounded-lg mb-6">
                        <h3 class="font-semibold text-[#1D1D1F] mb-2">Numero RTI</h3>
                        <div class="flex space-x-2">
                            <input data-sync="numero_rti" id="numero_rti" type="text" placeholder="RTI-2025-001" class="flex-1 bg-white p-3 rounded-lg focus:ring-2 focus:ring-[#007AFF] outline-none">
                            <button id="generate-rti-btn" class="bg-[#007AFF] text-white font-bold py-3 px-4 rounded-lg">üîÑ Genera Nuovo RTI</button>
                        </div>
                        <p class="text-sm text-[#86868B] mt-2">Il numero RTI viene generato automaticamente in modo incrementale. Puoi modificarlo manualmente se necessario.</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <input data-sync="data_intervento" id="data_intervento" type="date" placeholder="Data Intervento" class="bg-[#F2F2F7] p-3 rounded-lg">
                        <input data-sync="ora_intervento" id="ora_intervento" type="time" placeholder="Ora Intervento" class="bg-[#F2F2F7] p-3 rounded-lg">
                        <select data-sync="tecnico_intervento" id="tecnico_intervento" class="bg-[#F2F2F7] p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none">
                            <option value="">Seleziona Tecnico</option>
                            </select>
                        <input data-sync="numero_operai" id="numero_operai" type="number" placeholder="Numero Operai" value="1" class="bg-[#F2F2F7] p-3 rounded-lg">
                        </div>
                    <textarea data-sync="intervento_effettuato" id="intervento_effettuato" placeholder="Inserisci parole chiave (es. 'pulito filtri, controllato gas') e lascia che l'AI generi la descrizione..." rows="5" class="w-full mt-4 bg-[#F2F2F7] p-3 rounded-lg"></textarea>
                    <!-- GEMINI API BUTTON -->
                    <div class="mt-2 text-right">
                        <button id="generate-desc-btn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">‚ú® Genera Descrizione (AI)</button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm mt-6">
                        <h2 class="text-2xl font-bold text-[#1D1D1F] mb-4">üí∞ RTIDF - Configurazione Costo</h2>
                        <div class="bg-[#F2F2F7] p-4 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                <div>
                                    <label for="costo_totale_rtidf" class="text-sm font-medium text-[#86868B] block mb-2">Costo Totale RTIDF (‚Ç¨)</label>
                                    <input id="costo_totale_rtidf" type="number" step="0.01" value="0.00" readonly
                                            class="w-full bg-gray-200 p-3 rounded-lg border focus:ring-2 focus:ring-[#007AFF] outline-none">
                                    <p class="text-xs text-[#86868B] mt-1">Questo campo √® popolato automaticamente dal totale del MPLS.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <section id="mpls" class="hidden section-content section-fade-in">
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-[#1D1D1F] mb-4 lg:mb-0">üí∞ Preventivo Lavori (MPLS)</h2>
                    </div>
                    
                    <div class="bg-[#F2F2F7] p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-[#1D1D1F] mb-2">Numero MPLS/RTIDF</h3>
                        <input id="numero_mpls" type="text" placeholder="MPLS-2025-001" readonly class="w-full bg-white p-3 rounded-lg border-2 border-[#C6C6C8]">
                        <p class="text-sm text-[#86868B] mt-2">Il numero MPLS √® sincronizzato automaticamente con il numero RTI.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input id="mpls_cliente" type="text" placeholder="Cliente" readonly class="bg-[#E5E5E5] p-3 rounded-lg border-transparent">
                        <input id="mpls_condominio" type="text" placeholder="Condominio" readonly class="bg-[#E5E5E5] p-3 rounded-lg border-transparent">
                        <input id="mpls_indirizzo" type="text" placeholder="Indirizzo" readonly class="bg-[#E5E5E5] p-3 rounded-lg border-transparent md:col-span-2">
                        <input id="mpls_data_intervento" type="date" placeholder="Data Intervento" readonly class="bg-[#E5E5E5] p-3 rounded-lg border-transparent">
                        <input id="mpls_tecnico" type="text" placeholder="Tecnico" readonly class="bg-[#E5E5E5] p-3 rounded-lg border-transparent">
                    </div>
                    
                    <div class="bg-[#F2F2F7] p-4 rounded-lg">
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="is-guazzotti" class="h-5 w-5 rounded text-[#007AFF] focus:ring-[#007AFF]">
                                <span class="ml-2 text-[#1D1D1F]">Cliente Guazzotti (logica di calcolo speciale)</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="ore_manodopera" class="text-sm font-medium text-[#86868B]">Ore Manodopera</label>
                                <input id="ore_manodopera" type="number" value="0.0" class="w-full bg-white p-3 rounded-lg mt-1">
                            </div>
                            <div>
                                <label for="sovrapprezzo" class="text-sm font-medium text-[#86868B]">Sovrapprezzo Generico (‚Ç¨)</label>
                                <input id="sovrapprezzo" type="number" value="0.00" class="w-full bg-white p-3 rounded-lg mt-1">
                            </div>
                            <div>
                                <label for="iva-select" class="text-sm font-medium text-[#86868B]">Aliquota IVA</label>
                                <select id="iva-select" class="w-full bg-white p-3 rounded-lg mt-1">
                                    <option value="22">22%</option>
                                    <option value="10">10%</option>
                                    <option value="0">0%</option>
                                </select>
                            </div>
                            <button id="recalculate-btn" class="self-end bg-[#007AFF] text-white font-bold py-3 px-4 rounded-lg">üîÑ Ricalcola Totali</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-xl font-bold text-[#1D1D1F] mb-4">‚ûï Gestione Materiali</h3>

                    <!-- NUOVA SEZIONE: PROMEMORIA LOGICA DI RICARICO -->
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg mb-4" role="alert">
                        <p class="font-bold">Promemoria Logica di Ricarico Materiali</p>
                        <ul class="list-disc list-inside text-sm mt-2">
                            <li><b>Cliente Standard:</b>
                                <ul class="list-disc list-inside pl-5">
                                    <li><b>+40%</b> su materiali con costo d'acquisto &lt; 100‚Ç¨</li>
                                    <li><b>+35%</b> su materiali con costo d'acquisto tra 100‚Ç¨ e 200‚Ç¨</li>
                                    <li><b>+30%</b> su materiali con costo d'acquisto &gt; 200‚Ç¨</li>
                                </ul>
                            </li>
                            <li><b>Cliente Guazzotti:</b> Ricarico fisso del <b>+20%</b>.</li>
                        </ul>
                    </div>
                    <!-- FINE NUOVA SEZIONE -->

                    <div class="bg-[#F2F2F7] p-4 rounded-lg mb-4">
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
                            <input id="nome_materiale_entry" type="text" placeholder="Nome Materiale" class="lg:col-span-2 bg-white p-3 rounded-lg">
                            <input id="qta_materiale_entry" type="number" placeholder="Quantit√†" class="bg-white p-3 rounded-lg">
                            <input id="prezzo_materiale_entry" type="number" placeholder="Prezzo (‚Ç¨)" class="bg-white p-3 rounded-lg">
                            <button id="add-material-btn" class="bg-[#34C759] text-white font-bold py-3 px-4 rounded-lg">‚ûï Aggiungi</button>
                        </div>
                        <div class="mt-4">
                            <div id="material-dropzone" class="dropzone bg-gray-50 hover:bg-gray-100">
                                <input type="file" id="pdf-material-input" class="hidden" accept=".pdf" disabled>
                                <label for="pdf-material-input" class="cursor-pointer">
                                    <span class="text-2xl">üìÑ</span>
                                    <p class="mt-2 text-sm text-gray-600">Trascina qui il PDF dei materiali o fai clic per selezionarlo.</p>
                                    <p id="material-dropzone-label" class="text-xs text-red-500 mt-1">Caricamento disabilitato. Backend non pronto.</p>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left" id="materiali-table">
                            <thead>
                                <tr class="border-b-2 border-[#F2F2F7]">
                                    <th class="p-3">Nome</th>
                                    <th class="p-3 text-center">Qt√†</th>
                                    <th class="p-3 text-right">Prezzo Acquisto</th>
                                    <th class="p-3 text-right">Costo Totale</th>
                                    <th class="p-3 text-center">Azione</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows will be added dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-6 bg-[#F2F2F7] p-4 rounded-lg">
                        <h3 class="text-xl font-bold text-[#1D1D1F] mb-4">üìä Riepilogo Costi</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between"><span>Subtotale Materiali (vendita):</span><span id="summary-subtotale_materiali_vendita" class="font-semibold">‚Ç¨ 0,00</span></div>
                            <div class="flex justify-between"><span>Subtotale Manodopera:</span><span id="summary-subtotale_manodopera_vendita" class="font-semibold">‚Ç¨ 0,00</span></div>
                            <hr class="my-2 border-[#C6C6C8]">
                            <div class="flex justify-between text-sm text-[#86868B]"><span>Costo Gestione Pratica:</span><span id="summary-costo_gestione">‚Ç¨ 0,00</span></div>
                            <div class="flex justify-between text-sm text-[#86868B]"><span>Spese Interventi Brevi:</span><span id="summary-spese_brevi">‚Ç¨ 0,00</span></div>
                            <div class="flex justify-between text-sm text-[#86868B]"><span>Materiale di Consumo:</span><span id="summary-materiale_consumo">‚Ç¨ 0,00</span></div>
                            <div class="flex justify-between text-sm text-[#86868B]"><span>Sovrapprezzo Generico:</span><span id="summary-sovrapprezzo">‚Ç¨ 0,00</span></div>
                            <hr class="my-2 border-[#C6C6C8]">
                            <div class="flex justify-between font-semibold"><span>Imponibile:</span><span id="summary-totale_generale_vendita">‚Ç¨ 0,00</span></div>
                            <div class="flex justify-between font-semibold"><span>IVA (<span id="summary-iva_percentuale_label">22</span>%):</span><span id="summary-importo_iva">‚Ç¨ 0,00</span></div>
                            <hr class="my-2 border-[#C6C6C8]">
                            <div class="flex justify-between text-xl font-bold"><span>TOTALE FATTURA:</span><span id="summary-totale_ivato" class="text-[#007AFF]">‚Ç¨ 0,00</span></div>
                            <!-- NUOVA SEZIONE: VISUALIZZAZIONE MARGINE -->
                            <hr class="my-2 border-[#C6C6C8] border-dashed">
                            <div class="flex justify-between text-green-700">
                                <span class="font-semibold">Margine Totale (‚Ç¨):</span>
                                <span id="summary-margine_in_euro" class="font-bold">‚Ç¨ 0,00</span>
                            </div>
                            <div class="flex justify-between text-green-700">
                                <span class="font-semibold">Margine Totale (%):</span>
                                <span id="summary-margine_percentuale" class="font-bold">0,00%</span>
                            </div>
                            <!-- FINE NUOVA SEZIONE -->
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="finalize" class="hidden section-content section-fade-in">
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <h2 class="text-2xl font-bold text-[#1D1D1F] mb-4">üí∞ RTIDF - Configurazione Costo</h2>
                    <div class="bg-[#F2F2F7] p-4 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                            <div>
                                <label for="costo_totale_rtidf_finalize" class="text-sm font-medium text-[#86868B] block mb-2">Costo Totale RTIDF (‚Ç¨)</label>
                                <input id="costo_totale_rtidf_finalize" type="number" step="0.01" value="0.00" readonly
                                        class="w-full bg-gray-200 p-3 rounded-lg border focus:ring-2 focus:ring-[#007AFF] outline-none">
                                <p class="text-xs text-[#86868B] mt-1">Questo campo √® popolato automaticamente dal totale del MPLS.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <h2 class="text-2xl font-bold text-[#1D1D1F] mb-4">üìé Gestione Allegati</h2>
                    <div class="bg-[#F2F2F7] p-4 rounded-lg mb-4">
                        <div id="attachment-dropzone" class="dropzone bg-gray-50 hover:bg-gray-100">
                            <input type="file" id="attachment-input" class="hidden" accept="image/png, image/jpeg" multiple>
                            <label for="attachment-input" class="cursor-pointer">
                                <span class="text-2xl">üì∑</span>
                                <p class="mt-2 text-sm text-gray-600">Trascina qui le immagini (JPG, PNG) o fai clic per selezionarle.</p>
                            </label>
                        </div>
                        <button id="clear-attachments-btn" class="w-full mt-2 bg-[#FF3B30] text-white font-bold py-2 px-4 rounded-lg">üóëÔ∏è Rimuovi Tutti</button>
                    </div>
                    
                    <div id="attachments-list" class="space-y-2">
                        <!-- Attachments will be listed here -->
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-2xl font-bold text-[#1D1D1F] mb-4">‚úÖ Esportazione Documenti</h2>
                    <p class="text-[#86868B] mb-6">Genera i documenti finali per il cliente o per l'archiviazione interna.</p>
                    
                    <div class="bg-[#F2F2F7] p-4 rounded-lg mb-6">
                        <h3 class="font-semibold text-[#1D1D1F] mb-3">Opzioni di Esportazione</h3>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="include-attachments" class="h-4 w-4 rounded text-[#007AFF] focus:ring-[#007AFF]">
                                <span class="ml-2 text-sm">Includi allegati nei documenti</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="include-signature" class="h-4 w-4 rounded text-[#007AFF] focus:ring-[#007AFF]">
                                <span class="ml-2 text-sm">Includi spazio per firma cliente</span>
                            </label>
                        </div>
                        <div class="mt-4">
                            <label for="pdf-template-select" class="block text-sm font-medium text-[#1D1D1F] mb-2">Seleziona Template PDF:</label>
                            <select id="pdf-template-select" class="w-full bg-white p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none">
                                <option value="standard">Template Standard</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                        <button data-pdf-type="RTI" class="generate-pdf-btn bg-[#007AFF] text-white font-bold py-4 px-4 rounded-lg">
                            üìã <br>Genera RTI
                        </button>
                        <button data-pdf-type="RTIDF" class="generate-pdf-btn bg-[#5856D6] text-white font-bold py-4 px-4 rounded-lg">
                            üí∞ <br>Genera RTIDF
                        </button>
                        <button data-pdf-type="PREVENTIVO" class="generate-pdf-btn bg-[#FF2D55] text-white font-bold py-4 px-4 rounded-lg">
                            ‚úâÔ∏è <br>Preventivo Cliente (PL)
                        </button>
                        <button data-pdf-type="MPLS" class="generate-pdf-btn bg-[#FF9500] text-white font-bold py-4 px-4 rounded-lg">
                            üìä <br>Genera MPLS
                        </button>
                        <button data-pdf-type="COMPLETO" class="generate-pdf-btn bg-[#34C759] text-white font-bold py-4 px-4 rounded-lg">
                            üìÑ <br>Report Completo
                        </button>
                    </div>
                    
                    <div class="mt-4 text-sm text-[#86868B]">
                        <p><strong>RTI:</strong> Rapporto Tecnico di Intervento</p>
                        <p><strong>RTIDF:</strong> RTI con indicazione del costo totale</p>
                        <p><strong>Preventivo (PL):</strong> Offerta per il cliente (senza costi interni)</p>
                        <p><strong>MPLS:</strong> Preventivo dettagliato con materiali e margini</p>
                        <p><strong>Completo:</strong> Documento unico con tutti i dati</p>
                    </div>

                    <div class="bg-[#FFF5E6] p-4 rounded-lg mt-6 border border-[#FF9500]">
                        <h3 class="font-semibold text-[#D97706] mb-3">üõ†Ô∏è Debug: Esporta in formato HTML</h3>
                        <p class="text-sm text-[#B45309] mb-4">Usa questi pulsanti per scaricare una versione HTML del report. √à utile per controllare la formattazione e i dati prima di creare il PDF finale.</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                            <button data-html-type="RTI" class="generate-html-btn bg-[#FF9500] text-white font-bold py-4 px-4 rounded-lg">
                                üìã <br>RTI (HTML)
                            </button>
                            <button data-html-type="RTIDF" class="generate-html-btn bg-[#FF9500] text-white font-bold py-4 px-4 rounded-lg">
                                üí∞ <br>RTIDF (HTML)
                            </button>
                            <button data-html-type="PREVENTIVO" class="generate-html-btn bg-[#FF9500] text-white font-bold py-4 px-4 rounded-lg">
                                ‚úâÔ∏è <br>Preventivo (HTML)
                            </button>
                            <button data-html-type="MPLS" class="generate-html-btn bg-[#FF9500] text-white font-bold py-4 px-4 rounded-lg">
                                üìä <br>MPLS (HTML)
                            </button>
                            <button data-html-type="COMPLETO" class="generate-html-btn bg-[#FF9500] text-white font-bold py-4 px-4 rounded-lg">
                                üìÑ <br>Completo (HTML)
                            </button>
                        </div>
                    </div>

                    <div class="bg-green-100 p-4 rounded-lg mt-6 border border-green-500">
                        <h3 class="font-semibold text-green-800 mb-3">üìß Invia Chiusura Ticket</h3>
                        <p class="text-sm text-green-700 mb-4">Questo pulsante scaricher√† il report RTI in formato HTML e preparer√† una bozza di email nel tuo programma di posta predefinito. <strong>Dovrai allegare manually il file scaricato.</strong></p>
                        <button id="email-ticket-btn" class="w-full bg-green-600 text-white font-bold py-4 px-4 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            Invia Chiusura Ticket a Guazzotti
                        </button>
                    </div>

                </div>
            </section>
            
            <!-- NUOVA SEZIONE ARCHIVIO -->
            <section id="archivio" class="hidden section-content section-fade-in">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h2 class="text-2xl font-bold text-[#1D1D1F] mb-4 md:mb-0">üóÑÔ∏è Archivio Documenti</h2>
                        <div class="flex items-center space-x-2 w-full md:w-auto">
                            <!-- MODIFIED: Placeholder updated -->
                            <input type="text" id="archivio-search" placeholder="Cerca per cliente, condominio, n¬∞ RTI..." class="flex-grow bg-[#F2F2F7] p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none w-full md:w-64">
                            <select id="archivio-filter-type" class="bg-[#F2F2F7] p-3 rounded-lg border-transparent focus:ring-2 focus:ring-[#007AFF] outline-none">
                                <option value="all">Tutti i Tipi</option>
                                <option value="RTI">RTI</option>
                                <option value="RTIDF">RTIDF</option>
                                <option value="PREVENTIVO">Preventivo</option>
                                <option value="MPLS">MPLS</option>
                                <option value="COMPLETO">Completo</option>
                            </select>
                            <button id="clear-archive-btn" class="bg-[#FF3B30] text-white font-bold py-3 px-4 rounded-lg whitespace-nowrap">Svuota Archivio</button>
                        </div>
                    </div>
                    <div id="archivio-list" class="space-y-3">
                        <!-- I documenti archiviati verranno mostrati qui -->
                        <p class="text-center text-gray-500 py-8">L'archivio √® vuoto.</p>
                    </div>
                </div>
            </section>
            
        </main>
    </div>

    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center no-print">
        <div id="modal" class="bg-white p-8 rounded-xl shadow-2xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[80vh] flex flex-col">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-left"></h3>
            <div id="modal-message" class="mb-6 text-left overflow-y-auto prose max-w-none"></div>
            <div class="flex justify-end space-x-4 mt-auto pt-4">
                <button id="modal-action-btn" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg">Azione</button>
                <button id="modal-close" class="bg-[#007AFF] hover:bg-[#0056b3] text-white font-bold py-2 px-6 rounded-lg">OK</button>
            </div>
        </div>
    </div>
    <div id="loader-container" class="hidden fixed inset-0 bg-white bg-opacity-75 z-50 flex justify-center items-center no-print">
         <div class="loader"></div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const app = {
            state: {
                ticket: {},
                mpls: {
                    ore_manodopera: 0.0,
                    sovrapprezzo: 0.00,
                },
                materiali: [],
                isGuazzotti: false,
                risultatiCalcolo: {},
                rtiCounter: 1,
                currentYear: new Date().getFullYear(),
                attachments: [], 
                costoTotaleRtidf: 0.00,
                archivio: [],
                iva_percentuale: 22 // Default IVA
            },
            
            companyInfo: {
                name: "ACG CLIMA SERVICE S.R.L.",
                legalAddress: "Via Duccio Galimberti 47 ‚Äì 15121 ‚Äì Alessandria (AL)",
                operativeAddress: "Via Zanardi Bonfiglio 68 ‚Äì 27058 ‚Äì Voghera (PV)",
                vatNumber: "02735970069",
                sdiCode: "SUBM70N",
                rea: "AL ‚Äì 311785",
                phone: "0383/640606",
                email: "info@acgclimaservice.com",
                pec: "posta@pec.acgclimaservice.it"
            },

            technicians: ["Albanesi Gianluca", "Tosca Federico", "Troise Antonio", "Piparo Marco", "Dellafiore Lorenzo", "Dellafiore Victor", "Aime David"],
            
            elements: {
                // Main UI
                menuItems: document.querySelectorAll('.menu-item'),
                sections: document.querySelectorAll('.section-content'),
                statusLabel: document.getElementById('status-label'),
                
                // Anagrafica
                pdfTicketInput: document.getElementById('pdf-ticket-input'),
                ticketDropzone: document.getElementById('ticket-dropzone'),
                ticketDropzoneLabel: document.getElementById('ticket-dropzone-label'),
                clearTicketBtn: document.getElementById('clear-ticket-btn'),
                notes: document.getElementById('note'),
                diagnoseBtn: document.getElementById('diagnose-btn'),

                // Intervention
                generateRtiBtn: document.getElementById('generate-rti-btn'),
                numeroRti: document.getElementById('numero_rti'),
                dataIntervento: document.getElementById('data_intervento'),
                tecnicoAnagraficaSelect: document.getElementById('tecnico_anagrafica'),
                tecnicoInterventoSelect: document.getElementById('tecnico_intervento'),
                costoTotaleRtidf: document.getElementById('costo_totale_rtidf'),
                interventoEffettuato: document.getElementById('intervento_effettuato'),
                generateDescBtn: document.getElementById('generate-desc-btn'),
                
                // MPLS
                isGuazzottiCheckbox: document.getElementById('is-guazzotti'),
                recalculateBtn: document.getElementById('recalculate-btn'),
                addMaterialBtn: document.getElementById('add-material-btn'),
                materialiTableBody: document.querySelector('#materiali-table tbody'),
                pdfMaterialInput: document.getElementById('pdf-material-input'),
                materialDropzone: document.getElementById('material-dropzone'),
                materialDropzoneLabel: document.getElementById('material-dropzone-label'),
                numeroMpls: document.getElementById('numero_mpls'),
                mplsDataIntervento: document.getElementById('mpls_data_intervento'),
                oreManodopera: document.getElementById('ore_manodopera'),
                sovrapprezzo: document.getElementById('sovrapprezzo'),
                ivaSelect: document.getElementById('iva-select'),
                summaryIvaLabel: document.getElementById('summary-iva_percentuale_label'),

                // Finalize
                generatePdfBtns: document.querySelectorAll('.generate-pdf-btn'),
                generateHtmlBtns: document.querySelectorAll('.generate-html-btn'),
                emailTicketBtn: document.getElementById('email-ticket-btn'), 
                attachmentInput: document.getElementById('attachment-input'),
                attachmentDropzone: document.getElementById('attachment-dropzone'),
                clearAttachmentsBtn: document.getElementById('clear-attachments-btn'),
                attachmentsList: document.getElementById('attachments-list'),
                includeAttachments: document.getElementById('include-attachments'),
                includeSignature: document.getElementById('include-signature'),
                exportProjectBtn: document.getElementById('export-project-btn'),
                importProjectInput: document.getElementById('import-project-input'),
                pdfTemplateSelect: document.getElementById('pdf-template-select'),
                costoTotaleRtidfFinalize: document.getElementById('costo_totale_rtidf_finalize'),

                // Archivio
                archivioSearch: document.getElementById('archivio-search'),
                clearArchiveBtn: document.getElementById('clear-archive-btn'),
                archivioList: document.getElementById('archivio-list'),
                archivioFilterType: document.getElementById('archivio-filter-type'),

                // Modals & Loaders
                modalContainer: document.getElementById('modal-container'),
                modal: document.getElementById('modal'),
                modalTitle: document.getElementById('modal-title'),
                modalMessage: document.getElementById('modal-message'),
                modalClose: document.getElementById('modal-close'),
                modalActionBtn: document.getElementById('modal-action-btn'), 
                loaderContainer: document.getElementById('loader-container'),

                // Status Overlay
                statusOverlay: document.getElementById('status-overlay'),
                statusText: document.getElementById('status-text')
            },

            init() {
                this.checkBackendStatus();
                this.populateTechniciansDropdown();
                this.bindEvents();
                this.generateNextRTI();
                this.loadArchivio();
                this.updateUI();
                this.setCurrentDate(); 
                this.setupDropzones();
            },
            
            setupDropzones() {
                const setup = (dropzone, input) => {
                    dropzone.addEventListener('click', (e) => {
                        if (e.target.tagName.toLowerCase() !== 'label' && e.target.parentElement.tagName.toLowerCase() !== 'label') {
                            input.click();
                        }
                    });
                    
                    dropzone.addEventListener('dragenter', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
                    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
                    dropzone.addEventListener('dragleave', e => { e.preventDefault(); dropzone.classList.remove('dragover'); });
                    dropzone.addEventListener('drop', e => {
                        e.preventDefault();
                        dropzone.classList.remove('dragover');
                        const files = e.dataTransfer.files;
                        if(files.length > 0) {
                            input.files = files;
                            input.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                };
                
                setup(this.elements.ticketDropzone, this.elements.pdfTicketInput);
                setup(this.elements.materialDropzone, this.elements.pdfMaterialInput);
                setup(this.elements.attachmentDropzone, this.elements.attachmentInput);
            },

            checkBackendStatus() {
                const maxWaitTime = 180000;
                const checkInterval = 2000;
                let intervalId;

                const timeoutId = setTimeout(() => {
                    clearInterval(intervalId);
                    this.elements.statusText.textContent = 'Errore: Backend non raggiungibile.';
                    this.elements.statusOverlay.querySelector('.loader').style.display = 'none';
                }, maxWaitTime);

                intervalId = setInterval(async () => {
                    try {
                        const response = await fetch('http://127.0.0.1:5000/status');
                        if (response.ok) {
                            clearInterval(intervalId);
                            clearTimeout(timeoutId);
                            this.elements.statusOverlay.style.opacity = '0';
                            setTimeout(() => this.elements.statusOverlay.classList.add('hidden'), 500);
                            this.elements.pdfTicketInput.disabled = false;
                            this.elements.pdfMaterialInput.disabled = false;
                            this.elements.ticketDropzoneLabel.innerHTML = 'Caricamento abilitato. <br>Trascina qui il file PDF del ticket o fai clic per selezionarlo.';
                            this.elements.ticketDropzoneLabel.classList.replace('text-red-500', 'text-green-500');
                            this.elements.materialDropzoneLabel.innerHTML = 'Caricamento abilitato. <br>Trascina qui il PDF dei materiali o fai clic per selezionarlo.';
                            this.elements.materialDropzoneLabel.classList.replace('text-red-500', 'text-green-500');
                        }
                    } catch (error) {
                        console.log("Backend non ancora pronto, nuovo tentativo tra 2s...");
                    }
                }, checkInterval);
            },
            
            populateTechniciansDropdown() {
                this.technicians.forEach(tech => {
                    this.elements.tecnicoAnagraficaSelect.add(new Option(tech, tech));
                    this.elements.tecnicoInterventoSelect.add(new Option(tech, tech));
                });
            },

            setCurrentDate() {
                const today = new Date().toISOString().split('T')[0];
                if (!this.elements.dataIntervento.value) {
                    this.elements.dataIntervento.value = today;
                    this.syncMplsData();
                }
            },

            bindEvents() {
                this.elements.menuItems.forEach(item => item.addEventListener('click', () => this.showSection(item.dataset.section)));
                this.elements.pdfTicketInput.addEventListener('change', e => this.handlePdfUpload(e, 'ticket'));
                this.elements.pdfMaterialInput.addEventListener('change', e => this.handlePdfUpload(e, 'materiali'));
                this.elements.attachmentInput.addEventListener('change', e => this.handleAttachmentUpload(e));
                
                this.elements.clearTicketBtn.addEventListener('click', () => this.clearTicket());
                this.elements.clearAttachmentsBtn.addEventListener('click', () => this.clearAttachments());

                this.elements.isGuazzottiCheckbox.addEventListener('change', () => {
                    this.state.isGuazzotti = this.elements.isGuazzottiCheckbox.checked;
                    this.aggiornaCalcoli();
                });

                document.querySelectorAll('[data-sync]').forEach(el => el.addEventListener('input', () => this.syncMplsData()));

                this.elements.recalculateBtn.addEventListener('click', () => this.aggiornaCalcoli());
                this.elements.addMaterialBtn.addEventListener('click', () => this.addMaterial());
                
                this.elements.generatePdfBtns.forEach(btn => btn.addEventListener('click', () => this.generaPdf(btn.dataset.pdfType)));
                this.elements.generateHtmlBtns.forEach(btn => btn.addEventListener('click', () => this.generaHtml(btn.dataset.htmlType)));
                this.elements.emailTicketBtn.addEventListener('click', () => this.inviaChiusuraTicket()); 
                this.elements.exportProjectBtn.addEventListener('click', () => this.exportProjectJson());
                this.elements.importProjectInput.addEventListener('change', e => this.handleJsonUpload(e));
                
                this.elements.modalClose.addEventListener('click', () => this.hideModal());
                this.elements.modalActionBtn.addEventListener('click', () => { if (this.elements.modalActionBtn.onclick) this.elements.modalActionBtn.onclick(); });

                this.elements.generateRtiBtn.addEventListener('click', () => this.generateNextRTI());
                
                [this.elements.oreManodopera, this.elements.sovrapprezzo, this.elements.ivaSelect].forEach(el => {
                    el.addEventListener('input', () => this.aggiornaCalcoli());
                });
                
                this.elements.diagnoseBtn.addEventListener('click', () => this.handleDiagnose());
                this.elements.generateDescBtn.addEventListener('click', () => this.handleGenerateDescription());
                
                this.elements.archivioSearch.addEventListener('input', () => this.renderArchivio());
                this.elements.archivioFilterType.addEventListener('change', () => this.renderArchivio());
                this.elements.clearArchiveBtn.addEventListener('click', () => this.clearArchivio());
            },

            async callGeminiApi(prompt) {
                this.showLoader();
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`Errore API: ${response.status} ${errorBody?.error?.message || 'Errore sconosciuto'}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        const finishReason = result.candidates?.[0]?.finishReason;
                        if (finishReason === 'SAFETY' || finishReason === 'RECITATION') {
                            throw new Error(`La richiesta √® stata bloccata per motivi di sicurezza (${finishReason}). Modifica l'input.`);
                        }
                        throw new Error('La risposta dell\'AI non √® valida o √® vuota.');
                    }
                } catch (error) {
                    console.error("Dettagli errore chiamata AI:", error);
                    this.showModal("Errore Chiamata AI", `Impossibile completare la richiesta: ${error.message}`);
                    return null;
                } finally {
                    this.hideLoader();
                }
            },
            
            async handleDiagnose() {
                const faultDescription = this.elements.notes.value.trim();
                if (!faultDescription) {
                    this.showModal("Input Mancante", "Per favore, inserisci una descrizione del guasto nel campo 'Note'.");
                    return;
                }
                const prompt = `Sei un tecnico di climatizzazione esperto. Un cliente ha segnalato: "${faultDescription}". Fornisci un'analisi tecnica in Markdown con possibili cause e primi passi diagnostici.`;
                const aiResponse = await this.callGeminiApi(prompt);
                if (aiResponse) {
                    const formattedHtml = aiResponse
                        .replace(/### (.*)/g, '<h3 class="text-lg font-bold mt-4 mb-2">$1</h3>')
                        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                        .replace(/^- (.*)/gm, '<li class="ml-5 list-disc">$1</li>')
                        .replace(/^(\d+)\. (.*)/gm, '<li class="ml-5 list-decimal">$1. $2</li>')
                        .replace(/\n/g, '<br>');
                    this.showModal("‚ú® Suggerimento Diagnosi AI", formattedHtml);
                }
            },

            async handleGenerateDescription() {
                const keywords = this.elements.interventoEffettuato.value.trim();
                if (!keywords) {
                    this.showModal("Input Mancante", "Per favore, inserisci alcune parole chiave sull'intervento effettuato.");
                    return;
                }
                const prompt = `Sei un assistente per la compilazione di rapporti tecnici. Espandi le seguenti note: "${keywords}" in una descrizione formale e completa per un "Rapporto Tecnico di Intervento" ufficiale.`;
                const aiResponse = await this.callGeminiApi(prompt);
                if (aiResponse) {
                    this.elements.interventoEffettuato.value = aiResponse;
                    this.showModal("Descrizione Generata", "La descrizione dell'intervento √® stata compilata con successo dall'AI.");
                }
            },

            collectAllProjectData() {
                document.querySelectorAll('[data-sync]').forEach(el => this.state.ticket[el.dataset.sync] = el.value);
                this.state.mpls.ore_manodopera = parseFloat(this.elements.oreManodopera.value) || 0;
                this.state.mpls.sovrapprezzo = parseFloat(this.elements.sovrapprezzo.value) || 0;
                this.state.isGuazzotti = this.elements.isGuazzottiCheckbox.checked;
                this.state.iva_percentuale = parseInt(this.elements.ivaSelect.value, 10);
            },

            exportProjectJson() {
                this.collectAllProjectData();
                const clientName = (this.state.ticket.cliente || 'Progetto').replace(/[^a-zA-Z0-9\s]/g, '').trim().replace(/\s+/g, '_');
                const rtiNumber = (this.state.ticket.numero_rti || 'SenzaNumero').replace(/[^a-zA-Z0-9]/g, '');
                const filename = `ACG_Progetto_${clientName}_${rtiNumber}_${new Date().toISOString().split('T')[0]}.json`;
                try {
                    download(JSON.stringify(this.state, null, 2), filename, "application/json");
                    this.showModal("Esportazione Completata", `Progetto salvato come "${filename}".`);
                } catch (error) {
                    this.showModal("Errore Esportazione", "Impossibile salvare il progetto.");
                }
            },

            handleJsonUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                this.showLoader();
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        Object.assign(this.state, {
                            ticket: {},
                            mpls: { ore_manodopera: 0, sovrapprezzo: 0 },
                            materiali: [],
                            attachments: [],
                            risultatiCalcolo: {},
                            ...importedState,
                            archivio: this.state.archivio // Preserve existing archive
                        });
                        this.updateUI();
                        this.showModal("Importazione Completata", "Progetto caricato.");
                    } catch (error) {
                        this.showModal("Errore Importazione", `File JSON non valido o corrotto. ${error.message}`);
                    } finally {
                        this.hideLoader();
                        event.target.value = '';
                    }
                };
                reader.readAsText(file);
            },
            
            handleAttachmentUpload(event) {
                Array.from(event.target.files).forEach(file => {
                    if (file.size > 10 * 1024 * 1024) {
                        this.showModal("File Troppo Grande", `Il file ${file.name} supera i 10MB.`);
                        return;
                    }
                    if (!file.type.startsWith('image/')) {
                        this.showModal("File non supportato", `Il file ${file.name} non √® un'immagine. Sono ammessi solo file JPG e PNG.`);
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = e => {
                        this.state.attachments.push({ id: Date.now() + Math.random(), name: file.name, type: file.type, size: file.size, data: e.target.result, isImage: true });
                        this.updateAttachmentsList();
                    };
                    reader.readAsDataURL(file);
                });
                event.target.value = '';
            },

            updateAttachmentsList() {
                this.elements.attachmentsList.innerHTML = '';
                this.state.attachments.forEach(att => {
                    const div = document.createElement('div');
                    div.className = 'attachment-item';
                    div.innerHTML = `
                        <div class="flex items-center space-x-3 flex-1 overflow-hidden">
                            ${att.isImage ? `<img src="${att.data}" alt="${att.name}" class="attachment-preview shrink-0">` : `<span class="text-2xl shrink-0">üìÑ</span>`}
                            <div class="truncate"><p class="font-medium text-sm truncate">${att.name}</p><p class="text-xs text-gray-500">${this.formatFileSize(att.size)}</p></div>
                        </div>
                        <button onclick="app.removeAttachment(${att.id})" class="text-red-500 hover:text-red-700 p-2 shrink-0">üóëÔ∏è</button>`;
                    this.elements.attachmentsList.appendChild(div);
                });
            },

            removeAttachment(id) {
                this.state.attachments = this.state.attachments.filter(att => att.id !== id);
                this.updateAttachmentsList();
            },

            clearAttachments() {
                 this.showModal("Conferma Rimozione", "Sei sicuro di voler rimuovere tutti gli allegati?", "Rimuovi Tutti", () => {
                    this.state.attachments = [];
                    this.updateAttachmentsList();
                    this.hideModal();
                });
            },

            formatFileSize: bytes => (bytes === 0 ? '0 Bytes' : `${parseFloat((bytes / Math.pow(1024, Math.floor(Math.log(bytes) / Math.log(1024)))).toFixed(2))} ${['Bytes', 'KB', 'MB', 'GB'][Math.floor(Math.log(bytes) / Math.log(1024))]}`),
            formatDateItalian: dateString => dateString ? new Date(dateString).toLocaleDateString('it-IT') : '',
            parseDateItalian(dateString) {
                if (!dateString || /^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
                const parts = dateString.split('/');
                return parts.length === 3 ? `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}` : dateString;
            },

            generateNextRTI() {
                try {
                    this.state.rtiCounter = parseInt(localStorage.getItem('acgRtiCounter') || 1);
                } catch(e) { this.state.rtiCounter = 1; }
                this.elements.numeroRti.value = `RTI-${this.state.currentYear}-${String(this.state.rtiCounter).padStart(3, '0')}`;
                this.state.rtiCounter++;
                try {
                     localStorage.setItem('acgRtiCounter', this.state.rtiCounter.toString());
                } catch(e) { console.warn("localStorage non accessibile."); }
                this.syncMplsData();
            },
            
            syncMplsData() {
                document.querySelectorAll('[data-sync]').forEach(el => this.state.ticket[el.dataset.sync] = el.value);
                document.getElementById('mpls_cliente').value = this.state.ticket.cliente || '';
                document.getElementById('mpls_condominio').value = this.state.ticket.condominio || '';
                document.getElementById('mpls_indirizzo').value = this.state.ticket.indirizzo || '';
                document.getElementById('mpls_data_intervento').value = this.state.ticket.data_intervento || '';
                document.getElementById('mpls_tecnico').value = this.state.ticket.tecnico_intervento || '';
                this.elements.numeroMpls.value = (this.elements.numeroRti.value || '').replace('RTI-', 'MPLS-');
            },
            
            showSection(sectionId) {
                this.elements.sections.forEach(s => s.classList.add('hidden'));
                document.getElementById(sectionId).classList.remove('hidden');
                this.elements.menuItems.forEach(item => {
                    const isSelected = item.dataset.section === sectionId;
                    item.classList.toggle('bg-[#007AFF]', isSelected);
                    item.classList.toggle('text-white', isSelected);
                    if(isSelected) this.elements.statusLabel.textContent = `üìç ${item.querySelector('span:last-child').textContent}`;
                });
                if (sectionId === 'archivio') this.renderArchivio();
            },
            
            updateUI() {
                document.querySelectorAll('[data-sync]').forEach(el => el.value = this.state.ticket[el.dataset.sync] || '');
                this.elements.oreManodopera.value = this.state.mpls.ore_manodopera || 0;
                this.elements.sovrapprezzo.value = this.state.mpls.sovrapprezzo || 0;
                this.elements.isGuazzottiCheckbox.checked = this.state.isGuazzotti;
                this.elements.ivaSelect.value = this.state.iva_percentuale || 22;
                this.updateAttachmentsList();
                this.renderArchivio();
                this.syncMplsData();
                this.aggiornaCalcoli();
            },
            
            clearTicket() {
                this.showModal("Conferma Cancellazione", "Sei sicuro di voler cancellare tutti i dati del progetto?", "Cancella Tutto", () => {
                    this.state = {
                        ...this.state, // Preserve archive and counter
                        ticket: {}, mpls: { ore_manodopera: 0, sovrapprezzo: 0 }, materiali: [], isGuazzotti: false,
                        risultatiCalcolo: {}, attachments: [], costoTotaleRtidf: 0, iva_percentuale: 22
                    };
                    document.querySelectorAll('input:not([type=button]), textarea, select').forEach(el => {
                        if (el.type === 'checkbox') el.checked = false;
                        else if(el.id !== 'numero_rti') el.value = '';
                    });
                    this.generateNextRTI(); 
                    this.updateUI();
                    this.hideModal();
                    this.showModal("Dati Cancellati", "Tutti i campi sono stati puliti.");
                });
            },
            
            async handlePdfUpload(event, type) {
                const file = event.target.files[0];
                if (!file) return;
                this.showLoader();
                try {
                    const formData = new FormData();
                    formData.append('pdf_file', file);
                    const response = await fetch(`http://127.0.0.1:5000/parse-${type}`, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error((await response.json()).error || 'Errore di parsing.');
                    const parsedData = await response.json();
                    if (type === 'ticket') {
                        this.popolaDatiTicket(parsedData.data);
                        this.showModal("Successo", "Dati del ticket importati.");
                    } else {
                        this.state.materiali.push(...parsedData.data);
                        this.aggiornaCalcoli();
                        this.showModal("Successo", `${parsedData.data.length} materiali importati.`);
                    }
                } catch (error) {
                    this.showModal("Errore di Parsing", error.message);
                } finally {
                    this.hideLoader();
                    event.target.value = '';
                }
            },
            
            popolaDatiTicket(data) {
                Object.entries(data).forEach(([key, value]) => {
                    const el = document.getElementById(key);
                    if (el) {
                        el.value = (el.type === 'date') ? this.parseDateItalian(value) : value;
                        this.state.ticket[key] = el.value;
                    }
                });
                this.syncMplsData();
            },
            
            addMaterial() {
                const nome = document.getElementById('nome_materiale_entry').value.trim();
                const qta = parseFloat(document.getElementById('qta_materiale_entry').value);
                const prezzo = parseFloat(document.getElementById('prezzo_materiale_entry').value);
                if (!nome || isNaN(qta) || isNaN(prezzo) || qta <= 0 || prezzo < 0) {
                    this.showModal("Input non valido", "Inserisci nome, quantit√† e prezzo validi.");
                    return;
                }
                this.state.materiali.push({ nome, quantita: qta, prezzoAcquisto: prezzo });
                this.aggiornaCalcoli();
                ['nome_materiale_entry', 'qta_materiale_entry', 'prezzo_materiale_entry'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('nome_materiale_entry').focus();
            },

            removeMaterial(index) {
                this.state.materiali.splice(index, 1);
                this.aggiornaCalcoli();
            },

            aggiornaCalcoli() {
                this.collectAllProjectData();
                this.state.risultatiCalcolo = this.calcolaTotali();
                this.elements.materialiTableBody.innerHTML = this.state.materiali.map((mat, index) => `
                    <tr class="border-b border-[#F2F2F7]">
                        <td class="p-3">${mat.nome}</td>
                        <td class="p-3 text-center">${mat.quantita.toFixed(2)}</td>
                        <td class="p-3 text-right">${this.formattaEuro(mat.prezzoAcquisto)}</td>
                        <td class="p-3 text-right">${this.formattaEuro(mat.prezzoAcquisto * mat.quantita)}</td>
                        <td class="p-3 text-center"><button onclick="app.removeMaterial(${index})" class="text-red-500 hover:text-red-700">üóëÔ∏è</button></td>
                    </tr>`).join('');
                
                Object.entries(this.state.risultatiCalcolo).forEach(([key, value]) => {
                    const el = document.getElementById(`summary-${key.replace(/([A-Z])/g, "_$1").toLowerCase()}`);
                     if (el) {
                        if (key.includes('Percentuale')) el.textContent = `${(value || 0).toFixed(2).replace('.', ',')}%`;
                        else el.textContent = this.formattaEuro(value);
                    }
                });
                this.elements.summaryIvaLabel.textContent = this.state.iva_percentuale;
                const totaleIvato = this.state.risultatiCalcolo.totaleIvato || 0;
                this.elements.costoTotaleRtidf.value = totaleIvato.toFixed(2);
                this.elements.costoTotaleRtidfFinalize.value = totaleIvato.toFixed(2);
                this.state.costoTotaleRtidf = totaleIvato;
            },
            
            calcolaTotali() {
                const { ore_manodopera, sovrapprezzo } = this.state.mpls;
                const { isGuazzotti, iva_percentuale } = this.state;
                const { subtotaleMaterialiVendita } = this.state.materiali.reduce((acc, mat) => {
                    const costoAcquisto = mat.quantita * mat.prezzoAcquisto;
                    const ricarico = isGuazzotti ? 0.20 : (costoAcquisto < 100 ? 0.40 : (costoAcquisto <= 200 ? 0.35 : 0.30));
                    acc.subtotaleMaterialiVendita += costoAcquisto * (1 + ricarico);
                    return acc;
                }, { subtotaleMaterialiVendita: 0 });

                const costoOrarioVendita = isGuazzotti ? 25.0 : 40.0;
                const subtotaleManodoperaVendita = ore_manodopera * costoOrarioVendita;
                
                const costoMaterialiAcquisto = this.state.materiali.reduce((sum, mat) => sum + (mat.quantita * mat.prezzoAcquisto), 0);
                const costoGestione = isGuazzotti ? 0 : 30.0;
                const speseBrevi = (!isGuazzotti && ore_manodopera > 0 && ore_manodopera < 3) ? 30.0 : 0;
                const materialeConsumo = (!isGuazzotti && costoMaterialiAcquisto > 0) ? Math.max(10.0, costoMaterialiAcquisto * 0.03) : 0;
                const totaleCostiAccessori = costoGestione + speseBrevi + materialeConsumo + sovrapprezzo;

                const totaleGeneraleVendita = subtotaleMaterialiVendita + subtotaleManodoperaVendita + totaleCostiAccessori;
                const importoIva = totaleGeneraleVendita * (iva_percentuale / 100);
                const totaleIvato = totaleGeneraleVendita + importoIva;
                
                const costoOrarioAcquisto = 22.0;
                const costoTotaleAcquisto = costoMaterialiAcquisto + (ore_manodopera * costoOrarioAcquisto);
                
                const margineInEuro = totaleGeneraleVendita - costoTotaleAcquisto;
                const marginePercentuale = totaleGeneraleVendita > 0 ? (margineInEuro / totaleGeneraleVendita) * 100 : 0;

                return {
                    subtotaleMaterialiVendita, subtotaleManodoperaVendita, costoGestione, speseBrevi, materialeConsumo,
                    sovrapprezzo, totaleGeneraleVendita, margineInEuro, marginePercentuale, importoIva, totaleIvato
                };
            },
            
            generaPdf(pdfType) {
                this.collectAllProjectData();
                this.aggiornaCalcoli(); 
                this.showLoader();
                try {
                    const finalHtml = this.buildHtmlForPdf(pdfType);
                    if (!finalHtml) throw new Error("Generazione HTML fallita.");
                    this.addToArchivio(pdfType, finalHtml);
                    const printWindow = window.open('', '_blank');
                    printWindow.document.open();
                    printWindow.document.write(finalHtml);
                    printWindow.document.close();
                    setTimeout(() => {
                        printWindow.print();
                        this.hideLoader();
                        setTimeout(() => printWindow.close(), 1000);
                    }, 500);
                } catch (error) {
                    this.showModal("Errore Generazione PDF", `Si √® verificato un errore: ${error.message}`);
                    this.hideLoader();
                }
            },
            
            generaHtml(htmlType) {
                this.collectAllProjectData();
                this.aggiornaCalcoli(); 
                this.showLoader();
                try {
                    const finalHtml = this.buildHtmlForPdf(htmlType);
                    if (!finalHtml) throw new Error("Generazione HTML fallita.");
                    this.addToArchivio(htmlType, finalHtml);
                    const clientName = (this.state.ticket.cliente || 'Cliente').replace(/[^a-zA-Z0-9]/g, '');
                    const docNumber = (this.state.ticket.numero_rti || '000').replace(/[^a-zA-Z0-9]/g, '');
                    const downloadFileName = `${htmlType}_${clientName}_${docNumber}_DEBUG.html`;
                    download(finalHtml, downloadFileName, "text/html");
                    this.showModal("Successo", `File di debug "${downloadFileName}" generato e documento archiviato.`);
                } catch (error) {
                    this.showModal("Errore Generazione HTML", error.message);
                } finally {
                    this.hideLoader();
                }
            },
            
            buildHtmlForPdf(pdfType) {
                const htmlTemplate = `
                    <!DOCTYPE html><html lang="it"><head><meta charset="UTF-8"><title>Report</title><style>
                    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
                    body{font-family:'Roboto',sans-serif;font-size:9.5pt;color:#333;margin:0}
                    .page{padding:20px;page-break-after:always}.page:last-child{page-break-after:auto}
                    h1,h2,h3{font-weight:700;color:#2E8B57}
                    table{width:100%;border-collapse:collapse;margin-top:15px;font-size:9pt}
                    th,td{border:1px solid #ddd;padding:8px;text-align:left}
                    thead th{background-color:#2E8B57!important;color:#fff!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
                    tbody tr:nth-child(even){background-color:#f9f9f9!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
                    .section{margin-bottom:20px;page-break-inside:avoid}
                    .section-title{font-size:15pt;margin-bottom:10px;border-bottom:1px solid #2E8B57;padding-bottom:4px}
                    .total-box{background-color:#E6F5ED!important;border:1px solid #5BC87F;padding:15px;margin:20px 0;text-align:center;font-size:13pt;font-weight:700;color:#1D6B40;-webkit-print-color-adjust:exact;print-color-adjust:exact}
                    .signature-section{margin-top:50px;text-align:right;page-break-inside:avoid}
                    .signature-line{width:250px;border-top:1px solid #333;margin:0 0 5px auto}
                    figure.attachment{page-break-inside:avoid;text-align:center;margin:20px 0}
                    figure.attachment img{max-width:100%;max-height:500px;border:1px solid #ccc}
                    figure.attachment figcaption{font-size:9pt;color:#777;margin-top:5px}
                    .company-header{background-color:#2E8B57!important;padding:15px 20px;color:#fff;text-align:center;-webkit-print-color-adjust:exact;print-color-adjust:exact}
                    .company-header h1{font-size:20pt;color:#fff;margin:0}
                    .company-header p{font-size:8pt;margin:4px 0 0}
                    @media print{html,body{width:210mm;height:297mm;font-size:9pt}.page{margin:0;padding:10mm 15mm}}
                    </style></head><body><div class="page"><div class="content">{{REPORT_CONTENT}}</div></div></body></html>`;
                
                try {
                    const data = { ...this.state.ticket, ...this.state.risultatiCalcolo, ...this.state.mpls, iva_percentuale: this.state.iva_percentuale };
                    let docNumber = data.numero_rti || '';
                    let docTitle = "Report Generico";

                    switch(pdfType) {
                        case 'RTI': docTitle = "Rapporto Tecnico di Intervento (RTI)"; break;
                        case 'RTIDF': docTitle = "Report Tecnico Intervento con Corrispettivo (RTIDF)"; break;
                        case 'PREVENTIVO': docTitle = "Preventivo Lavori"; docNumber = docNumber.replace('RTI-', 'PL-'); break;
                        case 'MPLS': docTitle = "Preventivo Materiali e Lavori (MPLS)"; docNumber = docNumber.replace('RTI-', 'MPLS-'); break;
                        case 'COMPLETO': docTitle = "Report Completo (RTIDF + MPLS)"; break;
                    }

                    let reportContent = `
                        <div class="company-header"><h1>${this.companyInfo.name}</h1><p>${this.companyInfo.operativeAddress} | Tel: ${this.companyInfo.phone} | Email: ${this.companyInfo.email}</p><p>P.IVA/C.F.: ${this.companyInfo.vatNumber} | SDI: ${this.companyInfo.sdiCode}</p></div>
                        <div style="padding:10px 0;"><p style="text-align:right;font-size:9pt;color:#777">Data di compilazione: ${new Date().toLocaleDateString('it-IT')}</p>
                        <h2 style="font-size:18pt;text-align:center;margin-top:5px;margin-bottom:15px;color:#333">${docTitle}</h2>
                        <h3 style="font-size:13pt;text-align:center;margin-bottom:20px;color:#333;font-weight:700">Numero: ${docNumber}</h3>
                        <div class="section"><h2 class="section-title">Dettagli Cliente</h2><p><strong>Cliente:</strong> ${data.cliente||''}</p><p><strong>Condominio:</strong> ${data.condominio||''}</p><p><strong>Indirizzo:</strong> ${data.indirizzo||''}</p></div>`;

                    if (pdfType === 'RTI' || pdfType === 'RTIDF' || pdfType === 'COMPLETO' || pdfType === 'PREVENTIVO') {
                        reportContent += `<div class="section"><h2 class="section-title">Dettagli Intervento</h2><table><tbody>
                            <tr><td><strong>Data Intervento Previsto:</strong></td><td>${this.formatDateItalian(data.data_intervento)||''}</td></tr>
                            <tr><td><strong>Tecnico Esecutore:</strong></td><td>${data.tecnico_intervento||''}</td></tr>
                            <tr><td style="vertical-align:top"><strong>Descrizione Lavori da Eseguire:</strong></td><td>${(data.note||'').replace(/\n/g,'<br>')}</td></tr>
                        </tbody></table></div>`;
                        if ((data.intervento_effettuato||'').trim() && pdfType !== 'PREVENTIVO') {
                            reportContent += `<div class="section"><h2 class="section-title">Descrizione Intervento Effettuato</h2><p style="line-height:1.6">${(data.intervento_effettuato).replace(/\n/g,'<br>')}</p></div>`;
                        }
                    }

                    if (pdfType === 'RTIDF' || pdfType === 'COMPLETO') {
                         reportContent += `<div class="total-box">Costo Totale Intervento (IVA Inclusa): ${this.formattaEuro(data.totaleIvato)}</div>`;
                    }

                    if (pdfType === 'MPLS' || pdfType === 'COMPLETO' || pdfType === 'PREVENTIVO') {
                        const ricaricoFn = costo => this.state.isGuazzotti ? 0.20 : (costo < 100 ? 0.40 : (costo <= 200 ? 0.35 : 0.30));
                        const materialiRows = this.state.materiali.map(mat => {
                            const costoTotAcquisto = mat.prezzoAcquisto * mat.quantita;
                            const prezzoVendita = mat.prezzoAcquisto * (1 + ricaricoFn(costoTotAcquisto));
                            return `<tr><td>${mat.nome}</td><td style="text-align:center">${mat.quantita.toFixed(2)}</td><td style="text-align:right">${this.formattaEuro(prezzoVendita)}</td><td style="text-align:right">${this.formattaEuro(prezzoVendita * mat.quantita)}</td></tr>`;
                        }).join('');

                        let summaryTable;
                        let { subtotaleMaterialiVendita, subtotaleManodoperaVendita, costoGestione, speseBrevi, materialeConsumo, sovrapprezzo, totaleGeneraleVendita, importoIva, totaleIvato, margineInEuro, marginePercentuale } = data;
                        
                        if (pdfType === 'PREVENTIVO') {
                            const totaleCostiAccessori = costoGestione + speseBrevi + materialeConsumo + sovrapprezzo;
                            let manodoperaConRipartizione = subtotaleManodoperaVendita;
                            let materialiConRipartizione = subtotaleMaterialiVendita;

                            if (subtotaleManodoperaVendita > 0 && subtotaleMaterialiVendita > 0) {
                                manodoperaConRipartizione += totaleCostiAccessori / 2;
                                materialiConRipartizione += totaleCostiAccessori / 2;
                            } else if (subtotaleManodoperaVendita > 0) {
                                manodoperaConRipartizione += totaleCostiAccessori;
                            } else {
                                materialiConRipartizione += totaleCostiAccessori;
                            }

                            summaryTable = `
                                <tr><td>Subtotale Materiali:</td><td style="text-align:right;font-weight:700">${this.formattaEuro(materialiConRipartizione)}</td></tr>
                                <tr><td>Subtotale Manodopera:</td><td style="text-align:right;font-weight:700">${this.formattaEuro(manodoperaConRipartizione)}</td></tr>
                                <tr style="border-top:1.5px dashed #555"><td>Imponibile:</td><td style="text-align:right;font-weight:700">${this.formattaEuro(totaleGeneraleVendita)}</td></tr>
                                <tr><td>IVA (${data.iva_percentuale}%):</td><td style="text-align:right;font-weight:700">${this.formattaEuro(importoIva)}</td></tr>
                                <tr style="font-size:14pt;font-weight:700;color:#2E8B57;border-top:2px solid #333"><td style="padding-top:10px">TOTALE PREVENTIVO:</td><td style="text-align:right;padding-top:10px">${this.formattaEuro(totaleIvato)}</td></tr>`;
                        } else { // MPLS and COMPLETO
                            summaryTable = `
                                <tr><td>Subtotale Materiali:</td><td style="text-align:right;font-weight:700">${this.formattaEuro(subtotaleMaterialiVendita)}</td></tr>
                                <tr><td>Subtotale Manodopera:</td><td style="text-align:right;font-weight:700">${this.formattaEuro(subtotaleManodoperaVendita)}</td></tr>
                                <tr style="border-top:1px dashed #D1D1D1"><td>Costo Gestione Pratica:</td><td style="text-align:right;font-weight:700;border-top:1px dashed #D1D1D1">${this.formattaEuro(costoGestione)}</td></tr>
                                <tr><td>Spese Interventi Brevi:</td><td style="text-align:right;font-weight:700">${this.formattaEuro(speseBrevi)}</td></tr>
                                <tr><td>Materiale di Consumo:</td><td style="text-align:right;font-weight:700">${this.formattaEuro(materialeConsumo)}</td></tr>
                                <tr><td>Sovrapprezzo Generico:</td><td style="text-align:right;font-weight:700">${this.formattaEuro(sovrapprezzo)}</td></tr>
                                <tr style="border-top:1.5px dashed #555"><td>Imponibile:</td><td style="text-align:right;font-weight:700">${this.formattaEuro(totaleGeneraleVendita)}</td></tr>
                                <tr><td>IVA (${data.iva_percentuale}%):</td><td style="text-align:right;font-weight:700">${this.formattaEuro(importoIva)}</td></tr>
                                <tr style="font-size:14pt;font-weight:700;color:#2E8B57;border-top:2px solid #333"><td style="padding-top:10px">TOTALE FATTURA:</td><td style="text-align:right;padding-top:10px">${this.formattaEuro(totaleIvato)}</td></tr>
                                <tr style="border-top:1.5px dashed #555"><td style="font-weight:700;color:#1E8449">Margine Totale (‚Ç¨):</td><td style="text-align:right;font-weight:700;color:#1E8449">${this.formattaEuro(margineInEuro)}</td></tr>
                                <tr style="font-weight:700;color:#1E8449"><td>Margine Totale (%):</td><td style="text-align:right">${(marginePercentuale||0).toFixed(2).replace('.',',')}%</td></tr>`;
                        }
                        
                        reportContent += `<div class="section"><h2 class="section-title">Dettaglio Economico</h2><h3>Materiali e Servizi:</h3>
                            <table><thead><tr><th>Descrizione</th><th>Qt√†</th><th style="text-align:right">Prezzo Unitario</th><th style="text-align:right">Totale</th></tr></thead><tbody>${materialiRows}</tbody></table>
                            <h3 style="margin-top:20px">Riepilogo</h3><table style="width:50%;margin-left:auto"><tbody>${summaryTable}</tbody></table></div>`;
                    }
                    
                    if (this.elements.includeSignature.checked) {
                        reportContent += `<div class="signature-section"><div class="signature-line"></div><p style="font-size:10pt;color:#666;margin:0">Firma Cliente</p></div>`;
                    }
                    
                    if (this.elements.includeAttachments.checked && this.state.attachments.length > 0) {
                        const attachmentsContent = this.state.attachments.map(att => `<figure class="attachment"><img src="${att.data}" alt="${att.name}"><figcaption>${att.name}</figcaption></figure>`).join('');
                        reportContent += `<div class="section" style="page-break-before:always;"><h2 class="section-title">Allegati</h2>${attachmentsContent}</div>`;
                    }

                    reportContent += `</div>`;
                    return htmlTemplate.replace('{{REPORT_CONTENT}}', reportContent);
                } catch (error) {
                    console.error("Errore durante la costruzione dell'HTML: ", error);
                    this.showModal("Errore Template", `Impossibile costruire il documento: ${error.message}`);
                    return null;
                }
            },
            
            async inviaChiusuraTicket() {
                this.showLoader();
                this.collectAllProjectData();
                const numeroTicket = this.state.ticket.numero_ticket || '[NUMERO MANCANTE]';
                try {
                    const finalHtml = await this.buildHtmlForPdf('RTI');
                    if (!finalHtml) throw new Error("Impossibile generare il contenuto del report.");
                    const clientName = (this.state.ticket.cliente || 'Cliente').replace(/[^a-zA-Z0-9]/g, '');
                    const docNumber = (this.state.ticket.numero_rti || '000').replace(/[^a-zA-Z0-9]/g, '');
                    const downloadFileName = `RTI_${clientName}_${docNumber}.html`;
                    download(finalHtml, downloadFileName, "text/html");
                    const recipient = 'assistenza.tecnica@guazzottienergia.com';
                    const cc_recipient = 'ticketarchivio@inboxAC2.sendboard.com';
                    const subject = `Chiusura ticket n. ${numeroTicket}`;
                    const body = `Si invia in allegato la chiusura del ticket in oggetto.\n\nCordiali saluti`;
                    const mailtoLink = `mailto:${recipient}?cc=${cc_recipient}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    this.hideLoader();
                    this.showModal("Email Pronta", `Il file "${downloadFileName}" √® stato scaricato.\nClicca 'Apri Email' per aprire il tuo programma di posta. Ricordati di allegare manualmente il file prima di inviare.`, "Apri Email", () => {
                        window.location.href = mailtoLink;
                        this.hideModal();
                    });
                } catch (error) {
                    this.hideLoader();
                    this.showModal("Errore", `Si √® verificato un errore: ${error.message}`);
                }
            },
            
            saveArchivio() {
                try {
                    localStorage.setItem('acgArchivioDocumenti', JSON.stringify(this.state.archivio));
                } catch (e) {
                    this.showModal("Errore di Salvataggio", "Impossibile salvare l'archivio. Potrebbe essere pieno.");
                }
            },

            loadArchivio() {
                try {
                    const archivioSalvato = localStorage.getItem('acgArchivioDocumenti');
                    if (archivioSalvato) this.state.archivio = JSON.parse(archivioSalvato);
                } catch (e) { this.state.archivio = []; }
                this.renderArchivio();
            },

            // MODIFIED: Added 'condominioName' to the archived entry
            addToArchivio(docType, htmlContent) {
                const entry = {
                    id: Date.now(),
                    type: docType,
                    clientName: this.state.ticket.cliente || 'N/D',
                    condominioName: this.state.ticket.condominio || 'N/D',
                    rtiNumber: this.state.ticket.numero_rti || 'N/D',
                    date: new Date().toISOString(),
                    htmlContent: htmlContent
                };
                this.state.archivio.unshift(entry);
                this.saveArchivio();
            },

            // MODIFIED: Updated search logic and display format
            renderArchivio() {
                const searchTerm = this.elements.archivioSearch.value.toLowerCase();
                const typeFilter = this.elements.archivioFilterType.value;

                const filteredArchivio = this.state.archivio.filter(item => {
                    const searchTermMatch = item.clientName.toLowerCase().includes(searchTerm) || 
                                            item.rtiNumber.toLowerCase().includes(searchTerm) ||
                                            (item.condominioName && item.condominioName.toLowerCase().includes(searchTerm));
                    const typeMatch = (typeFilter === 'all') || (item.type === typeFilter);
                    return searchTermMatch && typeMatch;
                });

                if (filteredArchivio.length === 0) {
                    this.elements.archivioList.innerHTML = `<p class="text-center text-gray-500 py-8">${this.state.archivio.length > 0 ? 'Nessun documento trovato per la ricerca.' : "L'archivio √® vuoto."}</p>`;
                    return;
                }

                this.elements.archivioList.innerHTML = filteredArchivio.map(item => `
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-800">
                                <span class="font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${item.type}</span>
                                <span class="text-gray-500 mx-1">|</span>
                                <span>${item.rtiNumber}</span>
                                <span class="text-gray-500 mx-1">|</span>
                                <span>${new Date(item.date).toLocaleDateString('it-IT')}</span>
                            </p>
                            <p class="text-lg text-gray-900 mt-2 font-medium">${item.condominioName || 'Nessun condominio'}</p>
                            <p class="text-md text-gray-700">${item.clientName}</p>
                        </div>
                        <div class="flex space-x-2 shrink-0 w-full md:w-auto">
                            <button onclick="app.viewArchivedDocument(${item.id})" class="flex-1 md:flex-initial bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600">Visualizza</button>
                            <button onclick="app.deleteArchivedDocument(${item.id})" class="flex-1 md:flex-initial bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Elimina</button>
                        </div>
                    </div>`).join('');
            },
            
            viewArchivedDocument(id) {
                const item = this.state.archivio.find(doc => doc.id === id);
                if (item) {
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(item.htmlContent);
                    printWindow.document.close();
                } else { this.showModal("Errore", "Documento non trovato."); }
            },

            deleteArchivedDocument(id) {
                this.showModal("Conferma Eliminazione", "Sei sicuro di voler eliminare questo documento dall'archivio?", "Elimina", () => {
                    this.state.archivio = this.state.archivio.filter(item => item.id !== id);
                    this.saveArchivio();
                    this.renderArchivio();
                    this.hideModal();
                });
            },

            clearArchivio() {
                this.showModal("Conferma Svuota Archivio", "Sei sicuro di voler eliminare TUTTI i documenti dall'archivio?", "Svuota Tutto", () => {
                    this.state.archivio = [];
                    this.saveArchivio();
                    this.renderArchivio();
                    this.hideModal();
                });
            },

            formattaEuro: valore => `‚Ç¨ ${Number(valore || 0).toFixed(2).replace('.', ',')}`,
            showModal(title, message, actionText = null, actionCallback = null) {
                this.elements.modalTitle.textContent = title;
                this.elements.modalMessage.innerHTML = message.replace(/\n/g, '<br>'); 
                if (actionText && actionCallback) {
                    this.elements.modalActionBtn.textContent = actionText;
                    this.elements.modalActionBtn.onclick = actionCallback;
                    this.elements.modalActionBtn.classList.remove('hidden');
                    this.elements.modalClose.textContent = "Annulla";
                } else {
                    this.elements.modalActionBtn.classList.add('hidden');
                    this.elements.modalActionBtn.onclick = null;
                    this.elements.modalClose.textContent = "OK";
                }
                this.elements.modalContainer.classList.remove('hidden');
            },
            hideModal() {
                this.elements.modalContainer.classList.add('hidden');
            },
            showLoader() { this.elements.loaderContainer.classList.remove('hidden'); },
            hideLoader() { this.elements.loaderContainer.classList.add('hidden'); }
        };

        window.app = app;
        app.init();
    });
    </script>
</body>
</html>
