<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>{{ 'Modifica' if modalita == 'modifica' else 'Nuovo' }} Movimento Interno</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .form-group {
            position: relative;
        }
        
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .autocomplete-results.show {
            display: block;
        }
        
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .autocomplete-item:hover {
            background-color: #f0f0f0;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="/">üè† Dashboard</a></li>
                <li><a href="/ddt-in">üì• DDT IN</a></li>
                <li><a href="/ddt-out">üì§ DDT OUT</a></li>
                <li><a href="/inventario">üì¶ Inventario</a></li>
                <li><a href="/movimenti-interni" class="active">üîÑ Movimenti Interni</a></li>
            </ul>
        </nav>

        <div class="page-header">
            <h1>{{ '‚úèÔ∏è Modifica' if modalita == 'modifica' else '‚ûï Nuovo' }} Movimento Interno</h1>
            <button class="btn btn-secondary" onclick="window.location.href='/movimenti-interni'">
                ‚Üê Torna ai Movimenti
            </button>
        </div>

        <form method="post" id="movimentoForm" action="{{ '/movimenti-interni/' + movimento.id|string + '/modifica' if modalita == 'modifica' else '/movimenti-interni/nuovo' }}">
            <!-- Campi nascosti per i codici magazzino -->
            <input type="hidden" name="magazzino_partenza_codice" id="magazzino_partenza_codice">
            <input type="hidden" name="magazzino_destinazione_codice" id="magazzino_destinazione_codice">
            <div class="form-section">
                <h3>üìã Informazioni Generali</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Data Movimento</label>
                        <input type="date" name="data_movimento" value="{{ movimento.data_movimento.strftime('%Y-%m-%d') if modalita == 'modifica' and movimento.data_movimento else '' }}" required>
                    </div>
                    <div class="form-group">
                        <label>Numero Documento</label>
                        <input type="text" name="numero_documento" placeholder="Inserisci numero documento">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>üè¢ Magazzini</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Magazzino di Partenza</label>
                        <input type="text" name="magazzino_partenza" required 
                               placeholder="Cerca magazzino..." autocomplete="off"
                               value="{{ movimento.nome_magazzino_partenza if modalita == 'modifica' else (magazzino_predefinito.descrizione if magazzino_predefinito else '') }}"
                               data-codice="{{ movimento.magazzino_partenza if modalita == 'modifica' else (magazzino_predefinito.codice if magazzino_predefinito else '') }}">
                        <div class="autocomplete-results" id="magazzino-partenza-results"></div>
                    </div>
                    <div class="form-group">
                        <label>Magazzino di Destinazione</label>
                        <input type="text" name="magazzino_destinazione" required 
                               placeholder="Cerca magazzino..." autocomplete="off"
                               value="{{ movimento.nome_magazzino_destinazione if modalita == 'modifica' else '' }}"
                               data-codice="{{ movimento.magazzino_destinazione if modalita == 'modifica' else '' }}">
                        <div class="autocomplete-results" id="magazzino-destinazione-results"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Causale</label>
                    <input type="text" name="causale" placeholder="Motivo del movimento" value="{{ movimento.causale if modalita == 'modifica' else '' }}">
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea name="note" rows="3" placeholder="Note aggiuntive...">{{ movimento.note if modalita == 'modifica' else '' }}</textarea>
                </div>
            </div>

            <div class="form-section">
                <h3>üì¶ Articoli</h3>
                <div class="articles-container">
                    <div class="article-row" id="article-0">
                        <div class="form-group">
                            <label>Codice Articolo</label>
                            <input type="text" name="codice_0" 
                                   placeholder="Cerca articolo..." autocomplete="off"
                                   onkeyup="cercaArticolo(this, 0)">
                            <div class="autocomplete-results" id="articolo-results-0"></div>
                        </div>
                        <div class="form-group">
                            <label>Descrizione</label>
                            <input type="text" name="descrizione_0" readonly>
                        </div>
                        <div class="form-group">
                            <label>Giacenza Disponibile</label>
                            <input type="text" id="giacenza_0" readonly placeholder="0.00" class="giacenza-field">
                            <small id="magazzino_giacenza_0" class="giacenza-info">Seleziona magazzino e articolo</small>
                        </div>
                        <div class="form-group">
                            <label>Quantit√†</label>
                            <input type="number" name="quantita_0" min="0" step="0.01" required 
                                   onchange="validaGiacenza(0)">
                        </div>
                        <div class="form-group">
                            <label>U.M.</label>
                            <input type="text" name="unita_misura_0" readonly>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-danger btn-sm" onclick="rimuoviArticolo(0)">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="aggiungiArticolo()">
                    ‚ûï Aggiungi Articolo
                </button>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">üíæ {{ 'Aggiorna' if modalita == 'modifica' else 'Salva' }} Movimento</button>
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/movimenti-interni'">
                    ‚ùå Annulla
                </button>
            </div>
        </form>
    </div>

    <script>
    let articleCount = 1;

    // Setup autocomplete per magazzini
    function setupMagazziniAutocomplete() {
        const partenzaInput = document.querySelector('input[name="magazzino_partenza"]');
        const destinazioneInput = document.querySelector('input[name="magazzino_destinazione"]');
        
        partenzaInput.addEventListener('input', function() {
            cercaMagazzini(this.value, 'magazzino-partenza-results', 'magazzino_partenza');
        });
        
        destinazioneInput.addEventListener('input', function() {
            cercaMagazzini(this.value, 'magazzino-destinazione-results', 'magazzino_destinazione');
        });
    }

    function cercaMagazzini(query, resultsId, inputName) {
        const resultsDiv = document.getElementById(resultsId);
        
        if (query.length < 2) {
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('show');
            return;
        }

        fetch(`/api/magazzini/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                resultsDiv.innerHTML = '';
                
                if (data.length === 0) {
                    resultsDiv.classList.remove('show');
                    return;
                }
                
                data.forEach(magazzino => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.textContent = `${magazzino.codice} - ${magazzino.descrizione}`;
                    div.onclick = function() {
                        document.querySelector(`input[name="${inputName}"]`).value = magazzino.descrizione;
                        document.querySelector(`input[name="${inputName}"]`).dataset.codice = magazzino.codice;
                        
                        // DEBUG: Verifica che i valori vengano impostati correttamente
                        console.log(`DEBUG: Magazzino selezionato - Codice: ${magazzino.codice}, Descrizione: ${magazzino.descrizione}`);
                        console.log(`DEBUG: dataset.codice impostato a: ${document.querySelector(`input[name="${inputName}"]`).dataset.codice}`);
                        
                        // Popola anche il campo nascosto corrispondente
                        if (inputName === 'magazzino_partenza') {
                            document.getElementById('magazzino_partenza_codice').value = magazzino.codice;
                            console.log(`DEBUG: Campo nascosto magazzino_partenza_codice impostato a: ${magazzino.codice}`);
                        } else if (inputName === 'magazzino_destinazione') {
                            document.getElementById('magazzino_destinazione_codice').value = magazzino.codice;
                        }
                        
                        resultsDiv.innerHTML = '';
                        resultsDiv.classList.remove('show');
                        // Aggiorna giacenze quando cambia magazzino partenza - con ritardo per permettere l'aggiornamento DOM
                        if (inputName === 'magazzino_partenza') {
                            setTimeout(() => {
                                console.log('DEBUG: Chiamando aggiornaGiacenzePerMagazzino con ritardo...');
                                aggiornaGiacenzePerMagazzino();
                            }, 50); // 50ms di ritardo per permettere l'aggiornamento del DOM
                        }
                    };
                    resultsDiv.appendChild(div);
                });
                
                resultsDiv.classList.add('show');
            })
            .catch(error => {
                console.error('Errore ricerca magazzini:', error);
                resultsDiv.classList.remove('show');
            });
    }

    function cercaArticolo(input, index) {
        const query = input.value;
        const resultsDiv = document.getElementById(`articolo-results-${index}`);
        
        if (query.length < 2) {
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('show');
            return;
        }

        fetch(`/api/articoli/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                resultsDiv.innerHTML = '';
                
                if (data.length === 0) {
                    resultsDiv.classList.remove('show');
                    return;
                }
                
                data.forEach(articolo => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.textContent = `${articolo.codice_interno} - ${articolo.descrizione}`;
                    div.onclick = function() {
                        document.querySelector(`input[name="codice_${index}"]`).value = articolo.codice_interno;
                        document.querySelector(`input[name="descrizione_${index}"]`).value = articolo.descrizione;
                        document.querySelector(`input[name="unita_misura_${index}"]`).value = articolo.unita_misura || 'PZ';
                        resultsDiv.innerHTML = '';
                        resultsDiv.classList.remove('show');
                        // Aggiorna giacenza quando seleziono articolo
                        aggiornaGiacenza(index);
                    };
                    resultsDiv.appendChild(div);
                });
                
                resultsDiv.classList.add('show');
            })
            .catch(error => {
                console.error('Errore ricerca articoli:', error);
                resultsDiv.classList.remove('show');
            });
    }

    function aggiungiArticolo() {
        const container = document.querySelector('.articles-container');
        const newRow = document.createElement('div');
        newRow.className = 'article-row';
        newRow.id = `article-${articleCount}`;
        
        newRow.innerHTML = `
            <div class="form-group">
                <label>Codice Articolo</label>
                <input type="text" name="codice_${articleCount}" 
                       placeholder="Cerca articolo..." autocomplete="off"
                       onkeyup="cercaArticolo(this, ${articleCount})">
                <div class="autocomplete-results" id="articolo-results-${articleCount}"></div>
            </div>
            <div class="form-group">
                <label>Descrizione</label>
                <input type="text" name="descrizione_${articleCount}" readonly>
            </div>
            <div class="form-group">
                <label>Giacenza Disponibile</label>
                <input type="text" id="giacenza_${articleCount}" readonly placeholder="0.00" class="giacenza-field">
                <small id="magazzino_giacenza_${articleCount}" class="giacenza-info">Seleziona magazzino e articolo</small>
            </div>
            <div class="form-group">
                <label>Quantit√†</label>
                <input type="number" name="quantita_${articleCount}" min="0" step="0.01" required 
                       onchange="validaGiacenza(${articleCount})">
            </div>
            <div class="form-group">
                <label>U.M.</label>
                <input type="text" name="unita_misura_${articleCount}" readonly>
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-danger btn-sm" onclick="rimuoviArticolo(${articleCount})">
                    üóëÔ∏è
                </button>
            </div>
        `;
        
        container.appendChild(newRow);
        articleCount++;
    }

    function rimuoviArticolo(index) {
        const row = document.getElementById(`article-${index}`);
        if (row) {
            row.remove();
        }
    }

    // Funzione per aggiornare giacenza articolo
    function aggiornaGiacenza(index) {
        const codiceArticolo = document.querySelector(`input[name="codice_${index}"]`).value;
        const magazzinoPartenzaField = document.querySelector('input[name="magazzino_partenza"]');
        const magazzinoPartenzaCodiceField = document.getElementById('magazzino_partenza_codice');
        
        // USA IL CAMPO NASCOSTO che viene aggiornato correttamente, fallback al dataset e poi al value
        const codiceMagazzino = magazzinoPartenzaCodiceField.value || magazzinoPartenzaField.dataset.codice || magazzinoPartenzaField.value;
        const descrizioneMagazzino = magazzinoPartenzaField.value;
        
        console.log(`DEBUG aggiornaGiacenza: articolo=${codiceArticolo}, codiceMagazzino=${codiceMagazzino}, descrizioneMagazzino=${descrizioneMagazzino}`);
        console.log(`DEBUG aggiornaGiacenza: magazzinoPartenzaCodiceField.value = "${magazzinoPartenzaCodiceField.value}"`);
        console.log(`DEBUG aggiornaGiacenza: magazzinoPartenzaField.dataset.codice = "${magazzinoPartenzaField.dataset.codice}"`);
        console.log(`DEBUG aggiornaGiacenza: magazzinoPartenzaField.value = "${magazzinoPartenzaField.value}"`);
        
        if (!codiceArticolo) {
            console.log('DEBUG aggiornaGiacenza: Codice articolo mancante');
            document.getElementById(`giacenza_${index}`).value = '0.00';
            document.getElementById(`magazzino_giacenza_${index}`).textContent = 'Seleziona articolo';
            return;
        }
        
        if (!codiceMagazzino) {
            console.log('DEBUG aggiornaGiacenza: Codice magazzino mancante');
            document.getElementById(`giacenza_${index}`).value = '0.00';
            document.getElementById(`magazzino_giacenza_${index}`).textContent = 'Seleziona magazzino di partenza';
            return;
        }
        
        // Chiamata API per ottenere giacenza - preferisce codice magazzino ma accetta anche descrizione
        fetch(`/api/giacenza?codice=${encodeURIComponent(codiceArticolo)}&magazzino=${encodeURIComponent(codiceMagazzino)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('API Error:', data.error);
                    document.getElementById(`giacenza_${index}`).value = '0.00';
                    document.getElementById(`magazzino_giacenza_${index}`).textContent = `Errore: ${data.error}`;
                    return;
                }
                
                const giacenza = data.giacenza || 0;
                document.getElementById(`giacenza_${index}`).value = giacenza.toFixed(2);
                
                // Mostra sempre il magazzino richiesto
                let messaggioMagazzino = `Magazzino: ${descrizioneMagazzino}`;
                
                // Se giacenza √® 0, potrebbe significare che l'articolo non esiste in questo magazzino
                if (giacenza === 0) {
                    messaggioMagazzino = `Magazzino: ${descrizioneMagazzino} (giacenza: 0)`;
                }
                
                document.getElementById(`magazzino_giacenza_${index}`).textContent = messaggioMagazzino;
                
                // Valida subito se c'√® gi√† una quantit√† inserita
                validaGiacenza(index);
            })
            .catch(error => {
                console.error('Errore recupero giacenza:', error);
                document.getElementById(`giacenza_${index}`).value = '0.00';
                document.getElementById(`magazzino_giacenza_${index}`).textContent = 'Errore di rete recuperando giacenza';
            });
    }

    // Funzione per validare giacenza vs quantit√† richiesta
    function validaGiacenza(index) {
        const giacenzaField = document.getElementById(`giacenza_${index}`);
        const quantitaField = document.querySelector(`input[name="quantita_${index}"]`);
        const infoField = document.getElementById(`magazzino_giacenza_${index}`);
        
        if (!giacenzaField || !quantitaField) return;
        
        const giacenza = parseFloat(giacenzaField.value) || 0;
        const quantita = parseFloat(quantitaField.value) || 0;
        
        if (quantita > giacenza) {
            quantitaField.style.borderColor = '#dc3545';
            quantitaField.style.backgroundColor = '#f8d7da';
            infoField.textContent = `‚ö†Ô∏è Giacenza insufficiente! Disponibile: ${giacenza}`;
            infoField.style.color = '#dc3545';
        } else {
            quantitaField.style.borderColor = '';
            quantitaField.style.backgroundColor = '';
            infoField.textContent = `‚úÖ Magazzino: ${document.querySelector('input[name="magazzino_partenza"]').value}`;
            infoField.style.color = '#198754';
        }
    }

    // Aggiorna giacenze quando cambia magazzino di partenza
    function aggiornaGiacenzePerMagazzino() {
        // Trova tutte le righe articoli e aggiorna le loro giacenze
        const articoli = document.querySelectorAll('[id^="article-"]');
        articoli.forEach((articleDiv, index) => {
            const codiceInput = articleDiv.querySelector(`input[name="codice_${index}"]`);
            if (codiceInput && codiceInput.value) {
                aggiornaGiacenza(index);
            }
        });
    }

    // Initialize autocomplete
    document.addEventListener('DOMContentLoaded', function() {
        setupMagazziniAutocomplete();
        
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="data_movimento"]').value = today;
        
        // DEBUG: Verifica valori iniziali magazzino
        const magazzinoPartenzaField = document.querySelector('input[name="magazzino_partenza"]');
        console.log(`DEBUG INIT: Magazzino partenza value = "${magazzinoPartenzaField.value}"`);
        console.log(`DEBUG INIT: Magazzino partenza dataset.codice = "${magazzinoPartenzaField.dataset.codice}"`);
        
        // Se c'√® un magazzino preimpostato ma manca il dataset.codice, proviamo a recuperarlo
        if (magazzinoPartenzaField.value && !magazzinoPartenzaField.dataset.codice) {
            console.log('DEBUG INIT: Magazzino preimpostato senza codice, cercando il codice...');
            // Effettua una ricerca per ottenere il codice del magazzino preimpostato
            fetch(`/api/magazzini/search?q=${encodeURIComponent(magazzinoPartenzaField.value)}`)
                .then(response => response.json())
                .then(data => {
                    const magazzino = data.find(m => m.descrizione === magazzinoPartenzaField.value);
                    if (magazzino) {
                        magazzinoPartenzaField.dataset.codice = magazzino.codice;
                        document.getElementById('magazzino_partenza_codice').value = magazzino.codice;
                        console.log(`DEBUG INIT: Codice magazzino trovato e impostato: ${magazzino.codice}`);
                    }
                })
                .catch(error => console.error('Errore ricerca codice magazzino iniziale:', error));
        }
        
        // Inizializza i campi nascosti con i valori esistenti (per modifica)
        const magazzinoPartenzaInput = document.querySelector('input[name="magazzino_partenza"]');
        const magazzinoDestinazioneInput = document.querySelector('input[name="magazzino_destinazione"]');
        
        if (magazzinoPartenzaInput && magazzinoPartenzaInput.dataset.codice) {
            document.getElementById('magazzino_partenza_codice').value = magazzinoPartenzaInput.dataset.codice;
        }
        if (magazzinoDestinazioneInput && magazzinoDestinazioneInput.dataset.codice) {
            document.getElementById('magazzino_destinazione_codice').value = magazzinoDestinazioneInput.dataset.codice;
        }
        
        // Aggiungi listener per aggiornare giacenze quando cambia magazzino partenza
        if (magazzinoPartenzaInput) {
            magazzinoPartenzaInput.addEventListener('change', aggiornaGiacenzePerMagazzino);
            magazzinoPartenzaInput.addEventListener('blur', aggiornaGiacenzePerMagazzino);
        }
    });
    </script>

    <style>
    .giacenza-field {
        background-color: #f8f9fa;
        color: #495057;
        font-weight: 500;
    }
    
    .giacenza-info {
        display: block;
        margin-top: 4px;
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .article-row {
        display: grid;
        grid-template-columns: 1fr 2fr 120px 80px 60px 40px;
        gap: 15px;
        align-items: start;
        margin-bottom: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    @media (max-width: 768px) {
        .article-row {
            grid-template-columns: 1fr;
            gap: 10px;
        }
    }
    </style>
</body>
</html>