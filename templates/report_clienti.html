<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Clienti - Sistema DDT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="/">üè† Dashboard</a></li>
                <li><a href="/reports">üìä Report</a></li>
                <li><a href="/reports/clienti" class="active">üë• Report Clienti</a></li>
            </ul>
        </nav>

        <div class="ddt-header">
            <h1>üë• Report Clienti</h1>
            <p>Analisi performance e statistiche clienti principali</p>
            <div style="margin-top: 15px;">
                <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Stampa</button>
                <button onclick="exportClienti()" class="btn btn-success">üìä Export Excel</button>
                <button onclick="window.location.href='/clienti'" class="btn btn-info">üë• Gestisci Clienti</button>
            </div>
        </div>

        <!-- Statistiche Rapide -->
        <div class="info-grid" style="margin-bottom: 30px;">
            <div class="info-item">
                <span class="info-label">Clienti Attivi</span>
                <span class="info-value">{{ top_clienti|length }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">DDT OUT Totali</span>
                <span class="info-value">{{ top_clienti|sum(attribute='totale_ddt')|int }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Valore Vendite</span>
                <span class="info-value">‚Ç¨ {{ "{:,.2f}".format(top_clienti|sum(attribute='valore_totale') or 0) }}</span>
            </div>
            <div class="info-item {{ 'warning' if clienti_inattivi > 5 else 'success' }}">
                <span class="info-label">Clienti Inattivi</span>
                <span class="info-value">{{ clienti_inattivi|default(0) }}</span>
            </div>
        </div>

        <!-- Top Clienti per DDT -->
        <div class="card">
            <h3>üèÜ Top Clienti per Numero DDT</h3>
            <p>Clienti con maggior numero di documenti di trasporto in uscita</p>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Cliente</th>
                            <th>DDT OUT</th>
                            <th>Valore Medio DDT</th>
                            <th>Valore Totale</th>
                            <th>Ultimo DDT</th>
                            <th>Performance</th>
                            <th>Fedelt√†</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cliente in top_clienti %}
                        {% set valore_medio = (cliente.valore_totale or 0) / (cliente.totale_ddt or 1) %}
                        {% set giorni_ultimo = (cliente.giorni_ultimo_ddt or 0) %}
                        <tr class="{{ 'success' if cliente.totale_ddt > 10 else 'warning' if cliente.totale_ddt > 5 else '' }}">
                            <td><strong>{{ loop.index }}</strong></td>
                            <td><strong>{{ cliente.cliente_nome[:50] + '...' if cliente.cliente_nome and cliente.cliente_nome|length > 50 else (cliente.cliente_nome or '-') }}</strong></td>
                            <td style="color: #28a745; font-weight: bold;">{{ cliente.totale_ddt or 0 }}</td>
                            <td>‚Ç¨ {{ "{:.2f}".format(valore_medio) }}</td>
                            <td><strong>‚Ç¨ {{ "{:,.2f}".format(cliente.valore_totale or 0) }}</strong></td>
                            <td>
                                {% if giorni_ultimo <= 7 %}
                                    <span style="color: #28a745;">{{ giorni_ultimo }} gg fa</span>
                                {% elif giorni_ultimo <= 30 %}
                                    <span style="color: #ffc107;">{{ giorni_ultimo }} gg fa</span>
                                {% else %}
                                    <span style="color: #dc3545;">{{ giorni_ultimo }} gg fa</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if cliente.totale_ddt > 20 %}
                                    <span style="color: #28a745; font-weight: bold;">üî• ALTA</span>
                                {% elif cliente.totale_ddt > 10 %}
                                    <span style="color: #ffc107; font-weight: bold;">‚ö° MEDIA</span>
                                {% else %}
                                    <span style="color: #dc3545;">üìâ BASSA</span>
                                {% endif %}
                            </td>
                            <td>
                                {% set fedelta = 100 - (giorni_ultimo * 1.5) if giorni_ultimo < 67 else 0 %}
                                {% if fedelta > 85 %}
                                    <span style="color: #28a745;">üíé VIP ({{ fedelta|int }}%)</span>
                                {% elif fedelta > 70 %}
                                    <span style="color: #007bff;">‚≠ê Premium ({{ fedelta|int }}%)</span>
                                {% elif fedelta > 50 %}
                                    <span style="color: #ffc107;">ü•â Standard ({{ fedelta|int }}%)</span>
                                {% else %}
                                    <span style="color: #dc3545;">üìâ Basic ({{ fedelta|int }}%)</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if giorni_ultimo <= 15 %}
                                    <span style="color: #28a745; font-weight: bold;">‚úÖ ATTIVO</span>
                                {% elif giorni_ultimo <= 30 %}
                                    <span style="color: #ffc107; font-weight: bold;">‚ö†Ô∏è MODERATO</span>
                                {% elif giorni_ultimo <= 60 %}
                                    <span style="color: #fd7e14; font-weight: bold;">üî∂ INATTIVO</span>
                                {% else %}
                                    <span style="color: #dc3545; font-weight: bold;">‚ùå CRITICO</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analisi Performance Vendite -->
        <div class="card" style="margin-top: 30px;">
            <h3>üí∞ Classificazione Clienti per Valore</h3>
            <p>Segmentazione per volume di vendite</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                
                <div style="padding: 20px; border-left: 4px solid #28a745; background: #f0f8f0;">
                    <h4 style="color: #28a745; margin: 0 0 10px 0;">üíé Clienti Premium</h4>
                    <p style="margin: 0; color: #666;">
                        <strong>{{ top_clienti|selectattr('valore_totale', 'gt', 5000)|list|length }}</strong> clienti<br>
                        Valore > ‚Ç¨5.000
                    </p>
                </div>

                <div style="padding: 20px; border-left: 4px solid #007bff; background: #f0f8ff;">
                    <h4 style="color: #007bff; margin: 0 0 10px 0;">‚≠ê Clienti Standard</h4>
                    <p style="margin: 0; color: #666;">
                        <strong>{{ (top_clienti|selectattr('valore_totale', 'gt', 1000)|list|length) - (top_clienti|selectattr('valore_totale', 'gt', 5000)|list|length) }}</strong> clienti<br>
                        Valore ‚Ç¨1.000 - ‚Ç¨5.000
                    </p>
                </div>

                <div style="padding: 20px; border-left: 4px solid #ffc107; background: #fff8e1;">
                    <h4 style="color: #ff8f00; margin: 0 0 10px 0;">ü•â Clienti Basic</h4>
                    <p style="margin: 0; color: #666;">
                        <strong>{{ (top_clienti|selectattr('valore_totale', 'gt', 500)|list|length) - (top_clienti|selectattr('valore_totale', 'gt', 1000)|list|length) }}</strong> clienti<br>
                        Valore ‚Ç¨500 - ‚Ç¨1.000
                    </p>
                </div>

                <div style="padding: 20px; border-left: 4px solid #dc3545; background: #fff5f5;">
                    <h4 style="color: #dc3545; margin: 0 0 10px 0;">üìâ Clienti Occasionali</h4>
                    <p style="margin: 0; color: #666;">
                        <strong>{{ top_clienti|selectattr('valore_totale', 'le', 500)|list|length }}</strong> clienti<br>
                        Valore < ‚Ç¨500
                    </p>
                </div>

            </div>
        </div>

        <!-- Analisi Temporale -->
        <div class="card" style="margin-top: 30px;">
            <h3>üìÖ Analisi Temporale Attivit√† Clienti</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                
                <div style="padding: 20px; border-left: 4px solid #28a745; background: #f0f8f0;">
                    <h4 style="color: #28a745; margin: 0 0 10px 0;">üî• Attivi Ultima Settimana</h4>
                    <p style="margin: 0; color: #666;">
                        <strong>{{ top_clienti|selectattr('giorni_ultimo_ddt', 'le', 7)|list|length }}</strong> clienti<br>
                        Acquisti regolari
                    </p>
                </div>

                <div style="padding: 20px; border-left: 4px solid #ffc107; background: #fff8e1;">
                    <h4 style="color: #ff8f00; margin: 0 0 10px 0;">‚ö° Attivi Ultimo Mese</h4>
                    <p style="margin: 0; color: #666;">
                        <strong>{{ top_clienti|selectattr('giorni_ultimo_ddt', 'le', 30)|list|length - top_clienti|selectattr('giorni_ultimo_ddt', 'le', 7)|list|length }}</strong> clienti<br>
                        Acquisti occasionali
                    </p>
                </div>

                <div style="padding: 20px; border-left: 4px solid #dc3545; background: #fff5f5;">
                    <h4 style="color: #dc3545; margin: 0 0 10px 0;">üêå Inattivi da Tempo</h4>
                    <p style="margin: 0; color: #666;">
                        <strong>{{ top_clienti|selectattr('giorni_ultimo_ddt', 'gt', 30)|list|length }}</strong> clienti<br>
                        Necessario follow-up
                    </p>
                </div>

            </div>
        </div>

        <!-- Clienti Critici -->
        {% set clienti_critici = top_clienti|selectattr('giorni_ultimo_ddt', 'gt', 60)|list %}
        {% if clienti_critici %}
        <div class="card" style="margin-top: 30px;">
            <h3>‚ö†Ô∏è Clienti Inattivi da Oltre 60 Giorni</h3>
            <p style="color: #dc3545;">Clienti che potrebbero richiedere attenzione commerciale</p>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Totale DDT</th>
                            <th>Valore Totale</th>
                            <th>Ultimo DDT</th>
                            <th>Giorni Inattivit√†</th>
                            <th>Priorit√†</th>
                            <th>Azione Suggerita</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cliente in clienti_critici %}
                        <tr class="warning">
                            <td><strong>{{ cliente.cliente_nome or '-' }}</strong></td>
                            <td>{{ cliente.totale_ddt or 0 }}</td>
                            <td><strong>‚Ç¨ {{ "{:,.2f}".format(cliente.valore_totale or 0) }}</strong></td>
                            <td>{{ cliente.ultimo_ddt_data or '-' }}</td>
                            <td style="color: #dc3545; font-weight: bold;">{{ cliente.giorni_ultimo_ddt }} giorni</td>
                            <td>
                                {% if cliente.valore_totale > 2000 %}
                                    <span style="color: #dc3545; font-weight: bold;">üö® ALTA</span>
                                {% elif cliente.valore_totale > 500 %}
                                    <span style="color: #ffc107; font-weight: bold;">‚ö†Ô∏è MEDIA</span>
                                {% else %}
                                    <span style="color: #28a745;">üìâ BASSA</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if cliente.valore_totale > 2000 %}
                                    <span style="color: #dc3545;">üìû Chiamata urgente</span>
                                {% elif cliente.giorni_ultimo_ddt > 120 %}
                                    <span style="color: #ffc107;">‚úâÔ∏è Email follow-up</span>
                                {% else %}
                                    <span style="color: #007bff;">üìã Verifica interesse</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Valore a Rischio -->
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107;">
                <h4 style="margin: 0; color: #856404;">üí∏ Valore Cliente a Rischio</h4>
                <p style="margin: 10px 0 0 0; font-size: 1.2em; font-weight: bold; color: #856404;">
                    ‚Ç¨ {{ "{:,.2f}".format(clienti_critici|sum(attribute='valore_totale') or 0) }}
                </p>
            </div>
        </div>
        {% else %}
        <div class="card" style="margin-top: 30px; text-align: center; padding: 40px;">
            <h3 style="color: #28a745;">‚úÖ Situazione Normale</h3>
            <p>Tutti i clienti sono attivi negli ultimi 60 giorni</p>
        </div>
        {% endif %}

        <!-- Collegamenti Rapidi -->
        <div class="card" style="margin-top: 20px;">
            <h3>üîó Azioni Rapide</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                <button onclick="window.location.href='/clienti'" class="btn btn-primary">
                    üë• Gestisci Clienti
                </button>
                <button onclick="window.location.href='/ddt-out'" class="btn btn-secondary">
                    üì§ DDT OUT
                </button>
                <button onclick="window.location.href='/preventivi'" class="btn btn-info">
                    üìã Preventivi
                </button>
                <button onclick="window.location.href='/reports/dashboard'" class="btn btn-success">
                    üéØ Dashboard Esecutivo
                </button>
            </div>
        </div>

    </div>

    <script>
    function exportClienti() {
        window.location.href = '/reports/export/clienti';
    }

    // Calcola totali per le statistiche
    document.addEventListener('DOMContentLoaded', function() {
        // Aggiorna timestamp
        console.log('Report Clienti caricato');
    });
    </script>

    <style>
    .table-container {
        overflow-x: auto;
        margin-top: 15px;
    }

    .success {
        background-color: #d4edda !important;
    }

    .warning {
        background-color: #fff3cd !important;
    }

    .info-item.success .info-value {
        color: #28a745;
        font-weight: bold;
    }

    .info-item.warning .info-value {
        color: #ffc107;
        font-weight: bold;
    }

    @media print {
        nav { display: none; }
        .btn { display: none; }
        .card { page-break-inside: avoid; }
        .table-container { overflow: visible; }
    }
    </style>
</body>
</html>