<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifica DDT IN - Sistema Gestione DDT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=5">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <script src="{{ url_for('static', filename='autocomplete.js') }}"></script>
    <style>
        /* Miglioramenti per autocomplete mastrini */
        .table-container {
            position: relative;
        }
        
        .table-container table {
            margin-bottom: 60px;
        }
        
        /* Migliorato autocomplete per mastrini */
        .mastrino-input + .autocomplete-suggestions {
            z-index: 10000 !important;
            max-height: 200px !important;
            overflow-y: auto !important;
        }
        
        .autocomplete-wrapper {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="/">üè† Dashboard</a></li>
                <li><a href="/ddt-in">üì• DDT IN</a></li>
                <li><a href="/ddt-in/{{ ddt.id }}">üëÅÔ∏è Dettaglio DDT</a></li>
            </ul>
        </nav>

        <div class="ddt-header">
            <h1>‚úèÔ∏è Modifica DDT IN {{ ddt.numero_ddt or 'BOZZA-' + ddt.id|string }}</h1>
            <div class="filters">
                <button type="submit" form="form-modifica" class="btn btn-success">üíæ Salva Modifiche</button>
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/ddt-in/{{ ddt.id }}'">Annulla</button>
            </div>
        </div>

        <div class="table-container">
            <form method="POST" action="/ddt-in/{{ ddt.id }}/modifica" id="form-modifica">
                <h3>Informazioni DDT</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div>
                        <label>Data DDT Origine *</label>
                        <input type="date" name="data_ddt_origine" required style="width: 100%; margin-top: 5px;"
                               value="{{ ddt.data_ddt_origine.strftime('%Y-%m-%d') if ddt.data_ddt_origine else '' }}"
                               max="{{ today }}">
                    </div>
                    <div>
                        <label>Fornitore *</label>
                        <input type="text" name="fornitore" placeholder="Nome fornitore" required style="width: 100%; margin-top: 5px;"
                               value="{{ ddt.fornitore }}" data-source="fornitori" id="fornitore">
                        <div id="fornitore-suggestions" class="autocomplete-suggestions"></div>
                    </div>
                    <div>
                        <label>Riferimento</label>
                        <input type="text" name="riferimento" placeholder="N¬∞ ordine, bolla, ecc." style="width: 100%; margin-top: 5px;"
                               value="{{ ddt.riferimento }}">
                    </div>
                    <div>
                        <label>Destinazione *</label>
                        <select name="destinazione" required style="width: 100%; margin-top: 5px;">
                            {% for magazzino in magazzini %}
                            <option value="{{ magazzino.descrizione }}" 
                                    {% if magazzino.descrizione == ddt.destinazione %}selected{% endif %}>
                                {{ magazzino.descrizione }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label>Commessa</label>
                        <div class="autocomplete-container">
                            <input type="text" name="commessa" id="commessa-input" placeholder="Digita numero o descrizione commessa..." style="width: 100%; margin-top: 5px;"
                                   value="{{ ddt.commessa }}">
                        </div>
                    </div>
                    <!-- Campo mastrino rimosso: ora gestito per ogni articolo -->
                </div>

                <h3>Articoli</h3>
                <div style="margin-bottom: 15px;">
                    <button type="button" class="btn btn-secondary" onclick="aggiungiRiga()">+ Aggiungi Articolo</button>
                    <button type="button" class="btn btn-info" onclick="copiaMastrino()">üìã Copia Mastrino su Tutte le Righe</button>
                </div>

                <div class="table-container" style="max-height: 500px; overflow-y: auto; padding-bottom: 100px; position: relative;">
                    <table id="articoli-table">
                        <thead>
                            <tr>
                                <th>Codice Interno <small>(auto)</small></th>
                                <th>Codice Fornitore *</th>
                                <th>Descrizione *</th>
                                <th>Quantit√† *</th>
                                <th>U.M.</th>
                                <th>Costo Unitario *</th>
                                <th>Mastrino *</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="articoli-tbody">
                            {% for articolo in articoli %}
                            <tr>
                                <td><input type="text" name="articoli[{{ loop.index0 }}][codice]" 
                                          value="{{ articolo.codice_interno }}" readonly style="width: 100%; background: #f5f5f5;"></td>
                                <td><input type="text" name="articoli[{{ loop.index0 }}][codice_fornitore]" 
                                          value="{{ articolo.codice_fornitore }}" required style="width: 100%;"></td>
                                <td><input type="text" name="articoli[{{ loop.index0 }}][descrizione]" 
                                          value="{{ articolo.descrizione }}" required style="width: 100%;"></td>
                                <td><input type="number" name="articoli[{{ loop.index0 }}][quantita]" 
                                          value="{{ articolo.quantita }}" step="0.01" required style="width: 100%;"></td>
                                <td><input type="text" name="articoli[{{ loop.index0 }}][unita_misura]" 
                                          value="{{ articolo.unita_misura or 'PZ' }}" style="width: 100%;"></td>
                                <td><input type="number" name="articoli[{{ loop.index0 }}][costo]" 
                                          value="{{ articolo.costo_unitario }}" step="0.01" required style="width: 100%;"></td>
                                <td>
                                    <input type="text" name="articoli[{{ loop.index0 }}][mastrino]" 
                                           value="{{ articolo.mastrino_riga }}" required style="width: 100%;"
                                           class="mastrino-input" data-index="{{ loop.index0 }}">
                                </td>
                                <td><button type="button" onclick="rimuoviRiga(this)" class="btn btn-danger btn-small">üóëÔ∏è</button></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 30px;">
                    <p><strong>Note:</strong></p>
                    <ul>
                        <li>I campi contrassegnati con * sono obbligatori</li>
                        <li>Le modifiche verranno salvate solo dopo aver cliccato "Salva Modifiche"</li>
                    </ul>
                </div>
            </form>
        </div>

        <!-- Sezione Anteprima PDF -->

        <!-- SEMPRE MOSTRA SEZIONE DEBUG -->
        <div class="pdf-debug-section" style="background: #fff3cd; padding: 15px; margin: 20px 0; border-radius: 5px; border: 1px solid #ffeaa7;">
            <h4>üîç Debug PDF Info</h4>
            <p><strong>DDT ID:</strong> {{ ddt.id }}</p>
            <p><strong>Ha PDF allegato:</strong> {{ 'SI' if ddt.pdf_allegato else 'NO' }}</p>
            <p><strong>PDF filename:</strong> {{ ddt.pdf_filename or 'N/A' }}</p>
            <p><strong>PDF √® vuoto:</strong> {{ 'SI' if not ddt.pdf_allegato else 'NO' }}</p>
            <p><strong>PDF √® None:</strong> {{ 'SI' if ddt.pdf_allegato is none else 'NO' }}</p>
            <p><strong>Test condizione:</strong> {% if ddt.pdf_allegato %}VERO{% else %}FALSO{% endif %}</p>
        </div>

        {% if ddt.pdf_allegato %}
        <div class="pdf-preview-section">
            <h3>üìÑ Anteprima PDF - {{ ddt.pdf_filename or 'Documento' }}</h3>
            <div class="pdf-loading" id="pdf-loading" style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                üîÑ Caricamento PDF in corso...
            </div>
            <div class="pdf-container">
                <iframe id="pdf-viewer" src="" width="100%" height="800px" style="border: 1px solid #ddd; border-radius: 5px; display: none;">
                    <p>Il tuo browser non supporta la visualizzazione diretta dei PDF. <a id="pdf-download" href="">Scarica il PDF</a></p>
                </iframe>
                <div id="pdf-error" style="display: none; text-align: center; padding: 20px; background: #f8d7da; color: #721c24; border-radius: 5px;">
                    ‚ùå Errore caricamento PDF. <a id="pdf-download-fallback" href="">Clicca qui per scaricare</a>
                </div>
            </div>
        </div>

        <style>
        .pdf-preview-section {
            margin-top: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .pdf-preview-section h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }

        .pdf-container {
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .pdf-container iframe {
                height: 500px;
            }
        }
        </style>

        <script>
        // Carica il PDF nell'iframe quando la pagina √® pronta
        document.addEventListener('DOMContentLoaded', function() {
            {% if ddt.pdf_allegato %}
            const pdfUrl = '/ddt-in/{{ ddt.id }}/pdf';

            // Controlla se gli elementi esistono prima di impostare le propriet√†
            const pdfViewer = document.getElementById('pdf-viewer');
            const pdfDownload = document.getElementById('pdf-download');

            if (pdfViewer && pdfDownload) {
                console.log('[PDF] Inizializzando anteprima PDF per DDT {{ ddt.id }}');

                // Imposta i link di download
                pdfDownload.href = pdfUrl;
                const pdfDownloadFallback = document.getElementById('pdf-download-fallback');
                if (pdfDownloadFallback) {
                    pdfDownloadFallback.href = pdfUrl;
                }

                // Test prima se l'endpoint funziona
                console.log('[PDF] Testando endpoint PDF...');
                fetch(pdfUrl)
                    .then(response => {
                        console.log('[PDF] Response status:', response.status);
                        console.log('[PDF] Response headers:', response.headers);
                        if (response.ok) {
                            console.log('[PDF] Endpoint OK, caricamento PDF...');

                            // Gestione caricamento PDF
                            pdfViewer.onload = function() {
                                console.log('[PDF] PDF caricato con successo');
                                document.getElementById('pdf-loading').style.display = 'none';
                                pdfViewer.style.display = 'block';
                            };

                            pdfViewer.onerror = function() {
                                console.log('[PDF] Errore PDF diretto, tentativo PDF.js...');
                                const fullPdfUrl = window.location.origin + pdfUrl;
                                const pdfJsUrl = `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(fullPdfUrl)}`;
                                console.log('[PDF] PDF.js URL:', pdfJsUrl);
                                pdfViewer.src = pdfJsUrl;

                                // Secondo tentativo con timeout
                                setTimeout(function() {
                                    if (pdfViewer.style.display === 'none') {
                                        console.log('[PDF] Anche PDF.js fallito');
                                        document.getElementById('pdf-loading').style.display = 'none';
                                        document.getElementById('pdf-error').style.display = 'block';
                                    }
                                }, 8000);
                            };

                            // Carica PDF
                            pdfViewer.src = pdfUrl;
                        } else {
                            throw new Error(`HTTP ${response.status}`);
                        }
                    })
                    .catch(error => {
                        console.error('[PDF] Errore fetch endpoint:', error);
                        document.getElementById('pdf-loading').style.display = 'none';
                        document.getElementById('pdf-error').style.display = 'block';
                        document.getElementById('pdf-error').innerHTML = `‚ùå Errore caricamento PDF: ${error.message}. <a href="${pdfUrl}" target="_blank">Prova ad aprire direttamente</a>`;
                    });

                // Timeout globale
                setTimeout(function() {
                    if (document.getElementById('pdf-loading').style.display !== 'none') {
                        console.log('[PDF] Timeout globale - mostra errore');
                        document.getElementById('pdf-loading').style.display = 'none';
                        document.getElementById('pdf-error').style.display = 'block';
                        document.getElementById('pdf-error').innerHTML = `‚ùå Timeout caricamento PDF. <a href="${pdfUrl}" target="_blank">Clicca qui per aprire direttamente</a>`;
                    }
                }, 15000); // 15 secondi timeout globale
            }
            {% endif %}
        });
        </script>
        {% else %}
        <!-- Nessun PDF allegato -->
        <div class="pdf-preview-section">
            <h3>üìÑ Nessun PDF allegato</h3>
            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px; color: #6c757d;">
                ‚ÑπÔ∏è Questo DDT non ha un PDF allegato.<br>
                I PDF vengono allegati automaticamente durante l'importazione via email o upload manuale.
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        let rigaCounter = {{ articoli|length }};

        function aggiungiRiga() {
            const tbody = document.getElementById('articoli-tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" name="articoli[${rigaCounter}][codice]" readonly style="width: 100%; background: #f5f5f5;" placeholder="Auto: 4 lett. + cod. forn."></td>
                <td><input type="text" name="articoli[${rigaCounter}][codice_fornitore]" required style="width: 100%;"></td>
                <td><input type="text" name="articoli[${rigaCounter}][descrizione]" required style="width: 100%;"></td>
                <td><input type="number" name="articoli[${rigaCounter}][quantita]" step="0.01" required style="width: 100%;"></td>
                <td><input type="text" name="articoli[${rigaCounter}][unita_misura]" value="PZ" style="width: 100%;"></td>
                <td><input type="number" name="articoli[${rigaCounter}][costo]" step="0.01" required style="width: 100%;"></td>
                <td><input type="text" name="articoli[${rigaCounter}][mastrino]" required style="width: 100%;" class="mastrino-input" data-index="${rigaCounter}"></td>
                <td><button type="button" onclick="rimuoviRiga(this)" class="btn btn-danger btn-small">üóëÔ∏è</button></td>
            `;
            
            // Configura event listener per il nuovo codice fornitore
            const codiceFornitoreInput = row.querySelector('input[name*="[codice_fornitore]"]');
            if (codiceFornitoreInput) {
                codiceFornitoreInput.addEventListener('input', function() {
                    aggiornaCodiceInterno(row);
                });
            }
            
            rigaCounter++;
        }

        function rimuoviRiga(btn) {
            btn.closest('tr').remove();
        }

        // Inizializza autocomplete
        function initAutocomplete(inputId, endpoint) {
            const input = document.getElementById(inputId);
            if (input) {
                if (inputId === 'fornitore') {
                    AutocompleteHelpers.setupFornitoriAutocomplete(input);
                }
            }
        }
        
        function setupMastriniAutocomplete() {
            const mastriniInputs = document.querySelectorAll('.mastrino-input');
            console.log('Inizializzando autocomplete per', mastriniInputs.length, 'input mastrini');
            
            mastriniInputs.forEach((input) => {
                const index = input.getAttribute('data-index');
                console.log('Setup autocomplete per input index:', index);
                AutocompleteHelpers.setupMastriniAutocomplete(input, 'ACQUISTO');
                
                // Test di verifica autocomplete
                input.addEventListener('focus', function() {
                    console.log('Focus su input mastrino:', input.name);
                    setTimeout(() => {
                        const suggestions = input.parentElement.querySelector('.autocomplete-suggestions');
                        if (suggestions) {
                            console.log('Elemento autocomplete trovato:', suggestions);
                        } else {
                            console.log('PROBLEMA: Elemento autocomplete NON trovato per:', input.name);
                        }
                    }, 100);
                });
            });
        }
        
        // Funzione per aggiornare il codice interno automaticamente
        function aggiornaCodiceInterno(row) {
            const fornitoreNome = document.getElementById('fornitore').value || '';
            const codiceFornitoreInput = row.querySelector('input[name*="[codice_fornitore]"]');
            const codiceInternoInput = row.querySelector('input[name*="[codice]"]');
            
            if (!codiceFornitoreInput || !codiceInternoInput) return;
            
            const codiceFornitore = codiceFornitoreInput.value.trim();
            
            if (codiceFornitore && fornitoreNome) {
                // Estrae prime 4 lettere del fornitore (solo caratteri alfabetici)
                const prefissoFornitore = fornitoreNome.match(/[A-Za-z]/g)?.slice(0, 4).join('').toUpperCase() || '';
                const codiceInterno = prefissoFornitore + codiceFornitore;
                codiceInternoInput.value = codiceInterno;
            } else {
                codiceInternoInput.value = codiceFornitore;
            }
        }
        
        // Funzione per configurare gli event listeners sui codici fornitore
        function setupCodiceAutoupdate() {
            const codiciFornitore = document.querySelectorAll('input[name*="[codice_fornitore]"]');
            
            codiciFornitore.forEach(input => {
                input.addEventListener('input', function() {
                    const row = this.closest('tr');
                    aggiornaCodiceInterno(row);
                });
            });
            
            // Listener per fornitore principale
            const fornitoreInput = document.getElementById('fornitore');
            if (fornitoreInput) {
                fornitoreInput.addEventListener('input', function() {
                    const rows = document.querySelectorAll('#articoli-tbody tr');
                    rows.forEach(row => aggiornaCodiceInterno(row));
                });
            }
        }

        // Funzione per copiare il mastrino su tutte le righe
        function copiaMastrino() {
            const firstMastrino = document.querySelector('input[name*="[mastrino]"]');
            if (!firstMastrino || !firstMastrino.value) {
                alert('Inserisci prima un mastrino nella prima riga');
                return;
            }
            
            const masterinoValue = firstMastrino.value;
            const allMastrini = document.querySelectorAll('input[name*="[mastrino]"]');
            
            allMastrini.forEach(input => {
                input.value = masterinoValue;
            });
            
            alert(`Mastrino "${masterinoValue}" copiato su tutte le righe`);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            initAutocomplete('fornitore', '/api/fornitori/search');
            setupMastriniAutocomplete();
            setupCodiceAutoupdate();
            
            // Inizializza autocomplete commessa
            const commessaInput = document.getElementById('commessa-input');
            if (commessaInput) {
                AutocompleteHelpers.setupCommesseAutocomplete(commessaInput);
            }
        });
    </script>
</body>
</html>