<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Magazzini - Sistema DDT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="/">üè† Dashboard</a></li>
                <li><a href="/clienti">üë• Clienti</a></li>
                <li><a href="/fornitori">üè≠ Fornitori</a></li>
                <li><a href="/magazzini" class="active">üè¢ Magazzini</a></li>
                <li><a href="/catalogo">üìö Catalogo</a></li>
                <li><a href="/inventario">üì¶ Inventario</a></li>
            </ul>
        </nav>

        <div class="ddt-header">
            <h1>üè¢ Gestione Magazzini</h1>
            <div class="filters">
                <input type="text" id="searchInput" placeholder="Cerca magazzino..." onkeyup="filtraTabella()">
                <button class="btn btn-success" onclick="nuovoMagazzino()">+ Nuovo Magazzino</button>
            </div>
        </div>

        <div class="info-section">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Magazzini Attivi</span>
                    <span class="info-value">{{ magazzini|length }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Magazzini con Responsabile</span>
                    <span class="info-value">{{ magazzini|selectattr('responsabile')|list|length }}</span>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table id="tabellaMagazzini">
                <thead>
                    <tr>
                        <th>Codice</th>
                        <th>Descrizione</th>
                        <th>Responsabile</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for magazzino in magazzini %}
                    <tr>
                        <td><strong>{{ magazzino.codice }}</strong></td>
                        <td>{{ magazzino.descrizione }}</td>
                        <td>{{ magazzino.responsabile or '-' }}</td>
                        <td>
                            <span class="status {{ 'confirmed' if magazzino.attivo else 'draft' }}">
                                {{ 'ATTIVO' if magazzino.attivo else 'INATTIVO' }}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-primary" onclick="modificaMagazzino({{ magazzino.id }})">‚úèÔ∏è</button>
                                <button class="btn-small btn-danger" onclick="eliminaMagazzino({{ magazzino.id }}, '{{ magazzino.codice }}', '{{ magazzino.descrizione }}')">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            Nessun magazzino configurato. <a href="#" onclick="nuovoMagazzino()">Aggiungi il primo magazzino</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal per nuovo/modifica magazzino -->
    <div id="modalMagazzino" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="chiudiModalMagazzino()">&times;</span>
            <h2 id="modalTitolo">Nuovo Magazzino</h2>
            
            <form id="formMagazzino" onsubmit="salvaMagazzino(event)">
                <input type="hidden" id="magazzinoId" value="">
                
                <div class="form-group">
                    <label for="codice" class="form-label">Codice Magazzino *</label>
                    <input type="text" id="codice" name="codice" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="descrizione" class="form-label">Descrizione *</label>
                    <input type="text" id="descrizione" name="descrizione" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="responsabile" class="form-label">Responsabile</label>
                    <input type="text" id="responsabile" name="responsabile" class="form-control">
                </div>
                
                <div class="form-actions">
                    <button type="button" onclick="chiudiModalMagazzino()" class="btn btn-secondary">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva Magazzino</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .btn-small {
            padding: 5px 8px;
            font-size: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-small.btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-small.btn-primary:hover {
            background: #5a6fd8;
        }
        
        .btn-small.btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-small.btn-danger:hover {
            background: #c82333;
        }

        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 15px;
            top: 10px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }
    </style>

    <script>
    function filtraTabella() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toUpperCase();
        const table = document.getElementById('tabellaMagazzini');
        const tr = table.getElementsByTagName('tr');
        
        for (let i = 1; i < tr.length; i++) {
            const tds = tr[i].getElementsByTagName('td');
            let found = false;
            
            for (let j = 0; j < tds.length; j++) {
                if (tds[j]) {
                    const txtValue = tds[j].textContent || tds[j].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
            }
            
            tr[i].style.display = found ? '' : 'none';
        }
    }
    
    function nuovoMagazzino() {
        document.getElementById('modalTitolo').textContent = 'Nuovo Magazzino';
        document.getElementById('magazzinoId').value = '';
        document.getElementById('formMagazzino').reset();
        document.getElementById('modalMagazzino').style.display = 'block';
    }
    
    function modificaMagazzino(id) {
        // Trova i dati del magazzino dalla tabella
        const rows = document.querySelectorAll('#tabellaMagazzini tbody tr');
        for (let row of rows) {
            const cells = row.getElementsByTagName('td');
            if (cells.length > 0) {
                const actionButtons = cells[4].querySelector('.action-buttons');
                if (actionButtons && actionButtons.innerHTML.includes(`modificaMagazzino(${id})`)) {
                    document.getElementById('modalTitolo').textContent = 'Modifica Magazzino';
                    document.getElementById('magazzinoId').value = id;
                    document.getElementById('codice').value = cells[0].textContent.trim();
                    document.getElementById('descrizione').value = cells[1].textContent.trim();
                    document.getElementById('responsabile').value = cells[2].textContent.trim() === '-' ? '' : cells[2].textContent.trim();
                    document.getElementById('modalMagazzino').style.display = 'block';
                    break;
                }
            }
        }
    }
    
    function salvaMagazzino(event) {
        event.preventDefault();
        
        const formData = new FormData();
        const magazzinoId = document.getElementById('magazzinoId').value;
        
        formData.append('codice', document.getElementById('codice').value);
        formData.append('descrizione', document.getElementById('descrizione').value);
        formData.append('responsabile', document.getElementById('responsabile').value);
        
        const url = magazzinoId ? `/magazzini/${magazzinoId}/modifica` : '/magazzini/nuovo';
        const method = 'POST';
        
        fetch(url, {
            method: method,
            body: formData
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Errore durante il salvataggio del magazzino');
            }
        })
        .catch(error => {
            alert('Errore durante il salvataggio del magazzino');
        });
    }
    
    function eliminaMagazzino(id, codice, descrizione) {
        if (confirm(`Sei sicuro di voler eliminare il magazzino?\n\n"${codice} - ${descrizione}"\n\nQuesta azione non pu√≤ essere annullata.`)) {
            fetch(`/magazzini/${id}/elimina`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Errore durante l\'eliminazione del magazzino');
                }
            })
            .catch(error => {
                alert('Errore durante l\'eliminazione del magazzino');
            });
        }
    }
    
    function chiudiModalMagazzino() {
        document.getElementById('modalMagazzino').style.display = 'none';
    }
    
    // Chiudi modal con ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            chiudiModalMagazzino();
        }
    });
    
    // Chiudi modal cliccando fuori
    window.onclick = function(event) {
        const modal = document.getElementById('modalMagazzino');
        if (event.target === modal) {
            chiudiModalMagazzino();
        }
    }
    </script>
</body>
</html>