<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Correzione Parsing AI - Sistema DDT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .correction-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .correction-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .correct { border-color: #28a745; background-color: #f8fff9; }
        .incorrect { border-color: #dc3545; background-color: #fff8f8; }
        .field-correction {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .learning-stats {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="/">üè† Dashboard</a></li>
                <li><a href="/offerte">üìã Offerte</a></li>
                <li><a href="/parsing/training" class="active">üß† AI Training</a></li>
            </ul>
        </nav>

        <div class="ddt-header">
            <h1>üß† Correzione e Training AI Parsing</h1>
            <p>Aiuta l'AI a migliorare correggendo i campi sbagliati</p>
        </div>

        {% if parsing_data %}
        <div class="correction-grid">
            <!-- Risultato Parsing Originale -->
            <div class="correction-section incorrect">
                <h3>‚ùå Parsing AI Originale</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Fornitore</span>
                        <span class="info-value">{{ parsing_data.get('fornitore', 'N/A') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Numero Offerta</span>
                        <span class="info-value">{{ parsing_data.get('numero_ddt', 'N/A') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Data</span>
                        <span class="info-value">{{ parsing_data.get('data_ddt', 'N/A') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Totale</span>
                        <span class="info-value">{{ parsing_data.get('totale_fattura', 'N/A') }}</span>
                    </div>
                </div>
            </div>

            <!-- Form Correzione -->
            <div class="correction-section correct">
                <h3>‚úÖ Valori Corretti</h3>
                <form id="correctionForm" method="POST">
                    <input type="hidden" name="pdf_hash" value="{{ pdf_hash }}">
                    <input type="hidden" name="parsing_originale" value="{{ parsing_data | tojson }}">

                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Fornitore *</span>
                            <input type="text" name="fornitore_corretto"
                                   value="{{ parsing_data.get('fornitore', '') }}"
                                   class="info-value" required>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Numero Offerta</span>
                            <input type="text" name="numero_corretto"
                                   value="{{ parsing_data.get('numero_ddt', '') }}"
                                   class="info-value">
                        </div>
                        <div class="info-item">
                            <span class="info-label">Data (YYYY-MM-DD)</span>
                            <input type="date" name="data_corretta"
                                   value="{{ parsing_data.get('data_ddt', '') }}"
                                   class="info-value">
                        </div>
                        <div class="info-item">
                            <span class="info-label">Totale</span>
                            <input type="number" step="0.01" name="totale_corretto"
                                   value="{{ parsing_data.get('totale_fattura', '') }}"
                                   class="info-value">
                        </div>
                    </div>

                    <div class="field-correction">
                        <label for="campo_principale">Campo con errore principale:</label>
                        <select name="campo_principale" class="info-value">
                            <option value="fornitore">Fornitore</option>
                            <option value="numero_ddt">Numero Offerta</option>
                            <option value="data_ddt">Data</option>
                            <option value="totale_fattura">Totale</option>
                        </select>
                    </div>

                    <div class="field-correction">
                        <label for="note_correzione">Note per l'AI (come riconoscere correttamente):</label>
                        <textarea name="note_correzione" rows="3" class="info-value"
                                  placeholder="Es: Il fornitore √® sempre nella sezione in alto a sinistra, non confondere con il destinatario..."></textarea>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-success">üíæ Salva Correzione e Insegna all'AI</button>
                        <button type="button" onclick="skipCorrection()" class="btn btn-secondary">‚è≠Ô∏è Parsing Corretto - Salta</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Articoli se presenti -->
        {% if parsing_data.get('articoli') %}
        <div class="articles-section">
            <h3>üì¶ Articoli Estratti ({{ parsing_data.articoli | length }})</h3>
            <table class="articles-table">
                <thead>
                    <tr>
                        <th>Codice</th>
                        <th>Descrizione</th>
                        <th>Quantit√†</th>
                        <th>Prezzo</th>
                        <th>Totale</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for art in parsing_data.articoli[:5] %}
                    <tr>
                        <td>{{ art.get('codice', 'N/A') }}</td>
                        <td>{{ art.get('descrizione', 'N/A')[:50] }}...</td>
                        <td>{{ art.get('quantita', 'N/A') }}</td>
                        <td>‚Ç¨ {{ art.get('prezzo_unitario', 'N/A') }}</td>
                        <td>‚Ç¨ {{ art.get('totale_riga', 'N/A') }}</td>
                        <td>
                            <button onclick="correctArticle({{ loop.index0 }})" class="btn btn-sm">‚úèÔ∏è</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        {% endif %}

        <!-- Statistiche Learning -->
        <div class="learning-stats">
            <h3>üìä Statistiche Learning System</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <strong>Correzioni Totali:</strong> {{ stats.total_corrections or 0 }}
                </div>
                <div class="stat-item">
                    <strong>Fornitori con Regole:</strong> {{ stats.suppliers_with_rules or 0 }}
                </div>
                <div class="stat-item">
                    <strong>Accuratezza AI:</strong> {{ "%.1f%" | format((stats.accuracy or 0) * 100) }}
                </div>
            </div>
        </div>

    </div>

    <script>
        function skipCorrection() {
            if (confirm('Il parsing √® corretto? Questo confermer√† che l\'AI ha funzionato bene.')) {
                // Invia feedback positivo
                fetch('/parsing/feedback-positivo', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        pdf_hash: document.querySelector('input[name="pdf_hash"]').value,
                        parsing_data: JSON.parse(document.querySelector('input[name="parsing_originale"]').value)
                    })
                }).then(() => {
                    window.location.href = '/offerte';
                });
            }
        }

        function correctArticle(index) {
            // TODO: Implementare correzione articoli specifici
            alert('Correzione articoli in sviluppo - per ora correggi manualmente nell\'offerta');
        }

        document.getElementById('correctionForm').onsubmit = function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            fetch('/parsing/salva-correzione', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('‚úÖ Correzione salvata! L\'AI imparer√† da questo esempio.');
                    window.location.href = '/offerte';
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            });
        };
    </script>
</body>
</html>