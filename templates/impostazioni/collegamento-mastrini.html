<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Collegamento Mastrini - Sistema DDT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=4">
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="/">üè† Dashboard</a></li>
                <li><a href="/impostazioni" class="active">‚öôÔ∏è Impostazioni</a></li>
            </ul>
        </nav>

        <div class="ddt-header">
            <h1>üîó Collegamento Mastrini</h1>
            <div class="buttons">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/impostazioni'">‚Üê Torna alle Impostazioni</button>
            </div>
        </div>

        <!-- Form nuovo collegamento -->
        <div class="card">
            <h3>‚ûï Crea Nuovo Collegamento</h3>
            <form id="form-collegamento">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="mastrino_acquisto">Mastrino Acquisto *</label>
                        <select id="mastrino_acquisto" name="mastrino_acquisto_id" required>
                            <option value="">Seleziona mastrino acquisto...</option>
                            {% for mastrino in mastrini_acquisti %}
                            <option value="{{ mastrino.id }}">{{ mastrino.codice }} - {{ mastrino.descrizione }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="mastrino_ricavo">Mastrino Ricavo *</label>
                        <select id="mastrino_ricavo" name="mastrino_ricavo_id" required>
                            <option value="">Seleziona mastrino ricavo...</option>
                            {% for mastrino in mastrini_ricavi %}
                            <option value="{{ mastrino.id }}">{{ mastrino.codice }} - {{ mastrino.descrizione }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="descrizione">Descrizione Collegamento</label>
                    <input type="text" id="descrizione" name="descrizione_collegamento" 
                           placeholder="Descrizione del collegamento (opzionale)">
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üíæ Crea Collegamento</button>
                    <button type="reset" class="btn btn-secondary">üóëÔ∏è Reset</button>
                </div>
            </form>
        </div>

        <!-- Lista collegamenti esistenti -->
        <div class="card">
            <h3>üìã Collegamenti Esistenti</h3>
            
            {% if collegamenti %}
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Mastrino Acquisto</th>
                                <th>Mastrino Ricavo</th>
                                <th>Descrizione</th>
                                <th>Data Creazione</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for collegamento in collegamenti %}
                            <tr id="collegamento-{{ collegamento.id }}">
                                <td>
                                    <div>
                                        <strong>{{ collegamento.codice_acquisto }}</strong>
                                    </div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">
                                        {{ collegamento.desc_acquisto[:50] }}...
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ collegamento.codice_ricavo }}</strong>
                                    </div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">
                                        {{ collegamento.desc_ricavo[:50] }}...
                                    </div>
                                </td>
                                <td>{{ collegamento.descrizione_collegamento or '-' }}</td>
                                <td>{{ collegamento.data_creazione or 'N/A' }}</td>
                                <td>
                                    <button class="btn-icon btn-danger" 
                                            onclick="eliminaCollegamento({{ collegamento.id }})"
                                            title="Elimina collegamento">
                                        üóëÔ∏è
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="info-summary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="stat-item">
                            <div class="stat-number">{{ collegamenti|length }}</div>
                            <div class="stat-label">Collegamenti Attivi</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ mastrini_acquisti|length }}</div>
                            <div class="stat-label">Mastrini Acquisto</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ mastrini_ricavi|length }}</div>
                            <div class="stat-label">Mastrini Ricavo</div>
                        </div>
                    </div>
                </div>
                
            {% else %}
                <div style="text-align: center; padding: 60px; color: #a0aec0;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üîó</div>
                    <h3>Nessun collegamento configurato</h3>
                    <p>Crea il primo collegamento tra mastrini di acquisto e ricavo usando il form sopra.</p>
                </div>
            {% endif %}
        </div>

        <!-- Spiegazione funzionalit√† -->
        <div class="card">
            <h3>‚ÑπÔ∏è Come funziona</h3>
            <div class="info-content">
                <p><strong>Il collegamento tra mastrini</strong> consente di:</p>
                <ul>
                    <li>üìä <strong>Associare costi e ricavi:</strong> Collegare logicamente un mastrino di acquisto ad uno di ricavo</li>
                    <li>üìà <strong>Analisi margini:</strong> Calcolare automaticamente i margini confrontando acquisti e vendite</li>
                    <li>üîç <strong>Report dettagliati:</strong> Generare report che mostrano la correlazione tra costi sostenuti e ricavi generati</li>
                    <li>‚ö° <strong>Automazione:</strong> Suggerimenti automatici durante la creazione di DDT basati sui collegamenti</li>
                </ul>
                
                <div class="example-section" style="margin-top: 20px; padding: 15px; background: #e0f2fe; border-radius: 6px;">
                    <strong>üí° Esempio pratico:</strong><br>
                    Collegando "510001000 - Acquisti Materiale Idraulico" con "475001000 - Ricavi Lavori Idraulici", 
                    il sistema potr√† calcolare automaticamente il margine di profitto su ogni intervento idraulico.
                </div>
            </div>
        </div>
    </div>

    <style>
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3b82f6;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .btn-icon {
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-icon:hover {
            background: #e5e7eb;
        }
        
        .btn-icon.btn-danger {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .btn-icon.btn-danger:hover {
            background: #fecaca;
        }
        
        .info-content ul {
            margin: 15px 0;
            padding-left: 20px;
        }
        
        .info-content li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .example-section {
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        document.getElementById('form-collegamento').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '‚è≥ Creazione...';
            submitBtn.disabled = true;
            
            fetch('/impostazioni/collegamento-mastrini/nuovo', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    location.reload();
                } else {
                    alert('‚ùå ' + data.error);
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Errore di rete: ' + error.message);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });

        function eliminaCollegamento(id) {
            if (confirm('Sei sicuro di voler eliminare questo collegamento?\\n\\nQuesta azione non pu√≤ essere annullata.')) {
                fetch(`/impostazioni/collegamento-mastrini/${id}/elimina`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Rimuovi la riga dalla tabella
                        document.getElementById(`collegamento-${id}`).remove();
                        alert('‚úÖ ' + data.message);
                        
                        // Se non ci sono pi√π collegamenti, ricarica la pagina per mostrare il messaggio vuoto
                        const remainingRows = document.querySelectorAll('tbody tr');
                        if (remainingRows.length === 0) {
                            location.reload();
                        }
                    } else {
                        alert('‚ùå ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå Errore di rete: ' + error.message);
                });
            }
        }
    </script>
</body>
</html>