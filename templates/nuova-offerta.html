<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ 'Modifica' if modalita == 'modifica' else 'Nuova' }} Richiesta Offerta a Fornitore - Sistema DDT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=4">
    <script src="{{ url_for('static', filename='autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='autocompletamento.js') }}"></script>
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="/">üè† Dashboard</a></li>
                <li><a href="/ddt-in">üì• DDT IN</a></li>
                <li><a href="/ddt-out">üì§ DDT OUT</a></li>
                <li><a href="/offerte" class="active">üí∞ Offerte</a></li>
                <li><a href="/preventivi">üìã Preventivi</a></li>
                <li><a href="/catalogo">üìö Catalogo</a></li>
            </ul>
        </nav>

        <div class="ddt-header">
            <h1>üí∞ {{ 'Modifica' if modalita == 'modifica' else 'Nuova' }} Richiesta Offerta a Fornitore</h1>
            <p style="color: #8492a6; margin-top: 8px;">{{ 'Modifica richiesta di offerta esistente' if modalita == 'modifica' else 'Registra una nuova richiesta di offerta da inviare a un fornitore' }}</p>
        </div>

        <form method="POST" enctype="multipart/form-data" class="form-container" action="{{ '/offerte/' + offerta.id|string + '/modifica' if modalita == 'modifica' else '/offerte/nuova' }}">
            <!-- Dati testata offerta -->
            <div class="card">
                <h3>üì® Informazioni Generali</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fornitore_nome">Fornitore *</label>
                        <input type="text" id="fornitore_nome" name="fornitore_nome" placeholder="Digita per cercare fornitore..." required
                               value="{{ offerta.fornitore_nome if modalita == 'modifica' else '' }}">
                        <input type="hidden" id="fornitore_id" name="fornitore_id" value="{{ offerta.fornitore_id if modalita == 'modifica' else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="oggetto">Oggetto *</label>
                        <input type="text" id="oggetto" name="oggetto" required
                               placeholder="Descrizione offerta" value="{{ offerta.oggetto if modalita == 'modifica' else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="data_offerta">Data Richiesta Offerta</label>
                        <input type="date" id="data_offerta" name="data_offerta" value="{{ offerta.data_offerta.strftime('%Y-%m-%d') if modalita == 'modifica' and offerta.data_offerta else today|default('') }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="data_scadenza">Data Scadenza</label>
                        <input type="date" id="data_scadenza" name="data_scadenza" value="{{ offerta.data_scadenza.strftime('%Y-%m-%d') if modalita == 'modifica' and offerta.data_scadenza else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="priorita">Priorit√†</label>
                        <select id="priorita" name="priorita">
                            <option value="bassa" {{ 'selected' if modalita == 'modifica' and offerta.priorita == 'bassa' else '' }}>üü¢ Bassa</option>
                            <option value="media" {{ 'selected' if (modalita == 'modifica' and offerta.priorita == 'media') or (modalita != 'modifica') else '' }}>üü° Media</option>
                            <option value="alta" {{ 'selected' if modalita == 'modifica' and offerta.priorita == 'alta' else '' }}>üî¥ Alta</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="iva">IVA (%)</label>
                        <input type="number" id="iva" name="iva" value="{{ offerta.iva or 22 if modalita == 'modifica' else '22' }}" min="0" max="100" step="0.01">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="note">Note</label>
                    <textarea id="note" name="note" rows="3" placeholder="Note sull'offerta...">{{ offerta.note if modalita == 'modifica' else '' }}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="allegati">üìé Allegati</label>
                    <input type="file" id="allegati" name="allegati" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png">
                    <small style="color: #666; font-size: 0.85rem;">
                        Formati supportati: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG. Max 5MB per file.
                    </small>
                    <div id="allegati-list" class="allegati-preview">
                        {% if modalita == 'modifica' and offerta.allegati %}
                            {% set allegati_esistenti = offerta.allegati|from_json %}
                            {% if allegati_esistenti %}
                                <div style="margin-top: 10px;">
                                    <strong>Allegati esistenti:</strong>
                                    {% for allegato in allegati_esistenti %}
                                    <div class="allegato-esistente" style="padding: 5px; margin: 2px 0; background: #f5f5f5; border-radius: 3px;">
                                        üìé {{ allegato }}
                                        <button type="button" onclick="rimuoviAllegato('{{ allegato }}')" 
                                                style="margin-left: 10px; padding: 2px 6px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 2px;">
                                            ‚úï
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Dettagli offerta -->
            <div class="card">
                <h3>üì¶ Dettagli Offerta</h3>
                <div id="dettagli-container">
                    {% if modalita == 'modifica' and offerta.dettagli %}
                        <!-- Carica dettagli esistenti in modalit√† modifica -->
                        {% for dettaglio in offerta.dettagli %}
                        <div class="dettaglio-row" data-index="{{ loop.index0 }}">
                            <div class="form-grid dettaglio-grid">
                                <div class="form-group">
                                    <label>Cod. Interno</label>
                                    <input type="text" name="dettagli[{{ loop.index0 }}][codice]" 
                                           value="{{ dettaglio.codice_articolo or '' }}" placeholder="Codice...">
                                </div>
                                <div class="form-group">
                                    <label>Cod. Fornitore</label>
                                    <input type="text" name="dettagli[{{ loop.index0 }}][codice_fornitore]" 
                                           value="{{ dettaglio.codice_fornitore or '' }}" placeholder="Codice fornitore...">
                                </div>
                                <div class="form-group" style="position: relative;">
                                    <label>Descrizione *</label>
                                    <input type="text" name="dettagli[{{ loop.index0 }}][descrizione]" required 
                                           value="{{ dettaglio.descrizione or '' }}" placeholder="Descrizione articolo..." 
                                           oninput="cercaArticoloOfferta(this, {{ loop.index0 }})" autocomplete="off">
                                    <div class="autocomplete-results" id="articolo-results-{{ loop.index0 }}"></div>
                                </div>
                                <div class="form-group">
                                    <label>Quantit√† *</label>
                                    <input type="number" name="dettagli[{{ loop.index0 }}][quantita]" 
                                           value="{{ dettaglio.quantita or 1 }}" min="0.01" step="0.01" required 
                                           onchange="calcolaTotaleRiga({{ loop.index0 }})">
                                </div>
                                <div class="form-group">
                                    <label>U.M.</label>
                                    <select name="dettagli[{{ loop.index0 }}][unita]">
                                        <option value="PZ" {{ 'selected' if dettaglio.unita_misura == 'PZ' else '' }}>PZ</option>
                                        <option value="KG" {{ 'selected' if dettaglio.unita_misura == 'KG' else '' }}>KG</option>
                                        <option value="MT" {{ 'selected' if dettaglio.unita_misura == 'MT' else '' }}>MT</option>
                                        <option value="MQ" {{ 'selected' if dettaglio.unita_misura == 'MQ' else '' }}>MQ</option>
                                        <option value="MC" {{ 'selected' if dettaglio.unita_misura == 'MC' else '' }}>MC</option>
                                        <option value="LT" {{ 'selected' if dettaglio.unita_misura == 'LT' else '' }}>LT</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Prezzo Unit.</label>
                                    <input type="number" name="dettagli[{{ loop.index0 }}][prezzo_unitario]" 
                                           value="{{ dettaglio.prezzo_unitario or '' }}" min="0" step="0.01" 
                                           placeholder="0.00" onchange="calcolaTotaleRiga({{ loop.index0 }})">
                                </div>
                                <div class="form-group">
                                    <label>Sconto %</label>
                                    <input type="number" name="dettagli[{{ loop.index0 }}][sconto]" 
                                           value="{{ dettaglio.sconto_percentuale or 0 }}" min="0" max="100" step="0.01"
                                           onchange="calcolaTotaleRiga({{ loop.index0 }})">
                                </div>
                                <div class="form-group">
                                    <label>Disponibilit√†</label>
                                    <input type="text" name="dettagli[{{ loop.index0 }}][disponibilita]" 
                                           value="{{ dettaglio.disponibilita or '' }}" placeholder="Es: In stock">
                                </div>
                                <div class="form-group">
                                    <label>Tempi Consegna</label>
                                    <input type="text" name="dettagli[{{ loop.index0 }}][consegna]" 
                                           value="{{ dettaglio.tempo_consegna or '' }}" placeholder="Es: 15gg">
                                </div>
                                <div class="form-group">
                                    <label>Totale Riga</label>
                                    <input type="number" class="totale-riga" readonly 
                                           value="{{ '%.2f'|format(dettaglio.totale_riga or 0) }}">
                                </div>
                                <div class="form-group">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="rimuoviDettaglio({{ loop.index0 }})">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <!-- Riga vuota per nuove offerte -->
                        <div class="dettaglio-row" data-index="0">
                            <div class="form-grid dettaglio-grid">
                                <div class="form-group">
                                    <label>Cod. Interno</label>
                                    <input type="text" name="dettagli[0][codice]" placeholder="Codice...">
                                </div>
                                <div class="form-group">
                                    <label>Cod. Fornitore</label>
                                    <input type="text" name="dettagli[0][codice_fornitore]" placeholder="Codice fornitore...">
                                </div>
                                <div class="form-group" style="position: relative;">
                                    <label>Descrizione *</label>
                                    <input type="text" name="dettagli[0][descrizione]" required placeholder="Descrizione articolo..." 
                                           oninput="cercaArticoloOfferta(this, 0)" autocomplete="off">
                                    <div class="autocomplete-results" id="articolo-results-0"></div>
                                </div>
                                <div class="form-group">
                                    <label>Quantit√† *</label>
                                    <input type="number" name="dettagli[0][quantita]" value="1" min="0.01" step="0.01" required 
                                           onchange="calcolaTotaleRiga(0)">
                                </div>
                                <div class="form-group">
                                    <label>U.M.</label>
                                    <select name="dettagli[0][unita]">
                                        <option value="PZ">PZ</option>
                                        <option value="KG">KG</option>
                                        <option value="MT">MT</option>
                                        <option value="MQ">MQ</option>
                                        <option value="MC">MC</option>
                                        <option value="LT">LT</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Prezzo Unit.</label>
                                    <input type="number" name="dettagli[0][prezzo_unitario]" min="0" step="0.01"
                                           placeholder="0.00" onchange="calcolaTotaleRiga(0)">
                                </div>
                                <div class="form-group">
                                    <label>Sconto %</label>
                                    <input type="number" name="dettagli[0][sconto]" min="0" max="100" step="0.01" value="0"
                                           onchange="calcolaTotaleRiga(0)">
                                </div>
                                <div class="form-group">
                                    <label>Disponibilit√†</label>
                                    <input type="text" name="dettagli[0][disponibilita]" placeholder="Es: In stock">
                                </div>
                                <div class="form-group">
                                    <label>Tempi Consegna</label>
                                    <input type="text" name="dettagli[0][consegna]" placeholder="Es: 15gg">
                                </div>
                                <div class="form-group">
                                    <label>Totale Riga</label>
                                    <input type="number" class="totale-riga" readonly placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="rimuoviDettaglio(0)">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <div style="margin-top: 15px;">
                    <button type="button" class="btn btn-secondary" onclick="aggiungiDettaglio()">+ Aggiungi Riga</button>
                </div>
            </div>

            <!-- Riepilogo totali -->
            <div class="card">
                <h3>üí∞ Riepilogo Totali</h3>
                <div class="totali-grid">
                    <div class="totale-item">
                        <label>Totale Netto:</label>
                        <span id="totale-netto">‚Ç¨ 0.00</span>
                    </div>
                    <div class="totale-item">
                        <label>IVA:</label>
                        <span id="totale-iva">‚Ç¨ 0.00</span>
                    </div>
                    <div class="totale-item totale-finale">
                        <label>Totale Lordo:</label>
                        <span id="totale-lordo">‚Ç¨ 0.00</span>
                    </div>
                </div>
            </div>

            <!-- Pulsanti azione -->
            <div class="form-actions">
                <a href="/offerte" class="btn btn-secondary">‚¨ÖÔ∏è Annulla</a>
                <button type="submit" class="btn btn-success">üíæ {{ 'Aggiorna' if modalita == 'modifica' else 'Salva' }} Richiesta</button>
                
                {% if modalita == 'modifica' %}
                    <div style="border-left: 2px solid #e5e7eb; margin: 0 15px; padding-left: 15px; display: inline-block;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label for="cambio-stato" style="font-weight: 500; margin: 0;">Cambia Stato:</label>
                            <select id="cambio-stato" class="form-control" style="width: auto; min-width: 150px;">
                                <option value="">Seleziona nuovo stato...</option>
                                <option value="creata" {{ 'disabled' if offerta.stato == 'creata' else '' }}>üìù Creata</option>
                                <option value="richiesta" {{ 'disabled' if offerta.stato == 'richiesta' else '' }}>üìß Richiesta</option>
                                <option value="valutata" {{ 'disabled' if offerta.stato == 'valutata' else '' }}>üîç In Valutazione</option>
                                <option value="accettata" {{ 'disabled' if offerta.stato == 'accettata' else '' }}>‚úÖ Accettata</option>
                                <option value="rifiutata" {{ 'disabled' if offerta.stato == 'rifiutata' else '' }}>‚ùå Rifiutata</option>
                            </select>
                            <button type="button" class="btn btn-primary btn-sm" onclick="mostraModalCambioStato()">üîÑ Cambia</button>
                        </div>
                    </div>
                {% endif %}
            </div>
        </form>
    </div>

    <style>
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .autocomplete-results.show {
            display: block;
        }
        
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .autocomplete-item:hover {
            background-color: #f0f0f0;
        }
        
        .allegati-preview {
            margin-top: 10px;
        }
        
        .allegato-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }
        
        .allegato-nome {
            flex-grow: 1;
            margin-left: 8px;
            font-size: 0.9rem;
        }
        
        .allegato-size {
            color: #666;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .remove-allegato {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            margin-left: 8px;
        }
    </style>

    <script>
        let dettaglioIndex = {% if modalita == 'modifica' and offerta.dettagli %}{{ offerta.dettagli|length }}{% else %}1{% endif %};

        function updateFornitoreNome() {
            const select = document.getElementById('fornitore_id');
            const hiddenInput = document.getElementById('fornitore_nome');
            const selectedOption = select.options[select.selectedIndex];
            hiddenInput.value = selectedOption.getAttribute('data-nome') || '';
        }

        function aggiungiDettaglio() {
            const container = document.getElementById('dettagli-container');
            const newRow = document.createElement('div');
            newRow.className = 'dettaglio-row';
            newRow.setAttribute('data-index', dettaglioIndex);
            
            newRow.innerHTML = `
                <div class="form-grid dettaglio-grid">
                    <div class="form-group">
                        <label>Cod. Interno</label>
                        <input type="text" name="dettagli[${dettaglioIndex}][codice]" placeholder="Codice...">
                    </div>
                    <div class="form-group">
                        <label>Cod. Fornitore</label>
                        <input type="text" name="dettagli[${dettaglioIndex}][codice_fornitore]" placeholder="Codice fornitore...">
                    </div>
                    <div class="form-group" style="position: relative;">
                        <label>Descrizione *</label>
                        <input type="text" name="dettagli[${dettaglioIndex}][descrizione]" required placeholder="Descrizione articolo..." 
                               oninput="cercaArticoloOfferta(this, ${dettaglioIndex})" autocomplete="off">
                        <div class="autocomplete-results" id="articolo-results-${dettaglioIndex}"></div>
                    </div>
                    <div class="form-group">
                        <label>Quantit√† *</label>
                        <input type="number" name="dettagli[${dettaglioIndex}][quantita]" value="1" min="0.01" step="0.01" required 
                               onchange="calcolaTotaleRiga(${dettaglioIndex})">
                    </div>
                    <div class="form-group">
                        <label>U.M.</label>
                        <select name="dettagli[${dettaglioIndex}][unita]">
                            <option value="PZ">PZ</option>
                            <option value="KG">KG</option>
                            <option value="MT">MT</option>
                            <option value="MQ">MQ</option>
                            <option value="MC">MC</option>
                            <option value="LT">LT</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Prezzo Unit.</label>
                        <input type="number" name="dettagli[${dettaglioIndex}][prezzo_unitario]" min="0" step="0.01"
                               placeholder="0.00" onchange="calcolaTotaleRiga(${dettaglioIndex})">
                    </div>
                    <div class="form-group">
                        <label>Sconto %</label>
                        <input type="number" name="dettagli[${dettaglioIndex}][sconto]" min="0" max="100" step="0.01" value="0"
                               onchange="calcolaTotaleRiga(${dettaglioIndex})">
                    </div>
                    <div class="form-group">
                        <label>Disponibilit√†</label>
                        <input type="text" name="dettagli[${dettaglioIndex}][disponibilita]" placeholder="Es: In stock">
                    </div>
                    <div class="form-group">
                        <label>Tempi Consegna</label>
                        <input type="text" name="dettagli[${dettaglioIndex}][consegna]" placeholder="Es: 15gg">
                    </div>
                    <div class="form-group">
                        <label>Totale Riga</label>
                        <input type="number" class="totale-riga" readonly placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-danger btn-sm" onclick="rimuoviDettaglio(${dettaglioIndex})">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            
            container.appendChild(newRow);
            dettaglioIndex++;
            
            // Notifica che √® stata aggiunta una nuova riga per autocompletamento
            const event = new CustomEvent('nuovaRigaAggiunta', {
                detail: { riga: newRow }
            });
            document.dispatchEvent(event);
        }

        function rimuoviDettaglio(index) {
            const row = document.querySelector(`[data-index="${index}"]`);
            if (row && document.querySelectorAll('.dettaglio-row').length > 1) {
                row.remove();
                calcolaTotaliGenerali();
            }
        }

        function calcolaTotaleRiga(index) {
            const row = document.querySelector(`[data-index="${index}"]`);
            if (!row) return;
            
            const quantita = parseFloat(row.querySelector('[name*="[quantita]"]').value) || 0;
            const prezzo = parseFloat(row.querySelector('[name*="[prezzo_unitario]"]').value) || 0;
            const sconto = parseFloat(row.querySelector('[name*="[sconto]"]').value) || 0;
            
            const totaleRiga = quantita * prezzo * (1 - sconto/100);
            row.querySelector('.totale-riga').value = totaleRiga.toFixed(2);
            
            calcolaTotaliGenerali();
        }

        function calcolaTotaliGenerali() {
            const righe = document.querySelectorAll('.totale-riga');
            let totaleNetto = 0;
            
            righe.forEach(riga => {
                totaleNetto += parseFloat(riga.value) || 0;
            });
            
            const ivaPercentuale = parseFloat(document.getElementById('iva').value) || 0;
            const totaleIva = totaleNetto * ivaPercentuale / 100;
            const totaleLordo = totaleNetto + totaleIva;
            
            document.getElementById('totale-netto').textContent = `‚Ç¨ ${totaleNetto.toFixed(2)}`;
            document.getElementById('totale-iva').textContent = `‚Ç¨ ${totaleIva.toFixed(2)}`;
            document.getElementById('totale-lordo').textContent = `‚Ç¨ ${totaleLordo.toFixed(2)}`;
        }

        // Ricalcola totali quando cambia l'IVA
        document.getElementById('iva').addEventListener('change', calcolaTotaliGenerali);

        // Funzione per autocompletamento articoli
        function cercaArticoloOfferta(input, index) {
            const query = input.value;
            const resultsDiv = document.getElementById(`articolo-results-${index}`);
            
            if (query.length < 2) {
                resultsDiv.innerHTML = '';
                resultsDiv.classList.remove('show');
                return;
            }

            fetch(`/api/articoli/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    resultsDiv.innerHTML = '';
                    
                    if (data.length === 0) {
                        resultsDiv.classList.remove('show');
                        return;
                    }
                    
                    data.forEach(articolo => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-item';
                        div.textContent = `${articolo.codice_interno} - ${articolo.descrizione}`;
                        div.onclick = function() {
                            input.value = articolo.descrizione;
                            // Imposta anche il codice se c'√® un campo per quello
                            const codiceInput = input.closest('.dettaglio-row').querySelector('[name*="[codice]"]');
                            if (codiceInput) {
                                codiceInput.value = articolo.codice_interno;
                            }
                            resultsDiv.innerHTML = '';
                            resultsDiv.classList.remove('show');
                        };
                        resultsDiv.appendChild(div);
                    });
                    
                    resultsDiv.classList.add('show');
                })
                .catch(error => {
                    console.error('Errore ricerca articoli:', error);
                    resultsDiv.classList.remove('show');
                });
        }
    </script>

    <style>
        .dettaglio-grid {
            grid-template-columns: 100px 120px 2fr 80px 60px 100px 80px 100px 100px 100px 50px;
            gap: 8px;
            align-items: end;
        }
        
        .dettaglio-row {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .totali-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .totale-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .totale-finale {
            background: #e8f5e8;
            font-weight: 600;
            font-size: 1.1em;
        }
    </style>
    
    <script>
    // Funzione per aggiornare fornitore
    function updateFornitore(id, nome) {
        document.getElementById('fornitore_id').value = id;
        document.getElementById('fornitore_nome').value = nome;
    }
    
    // Funzione per rimuovere allegato esistente
    function rimuoviAllegato(nomeFile) {
        const allegatoDiv = event.target.parentElement;
        allegatoDiv.style.display = 'none';
        // Aggiungi campo hidden per segnalare la rimozione
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'allegati_da_rimuovere[]';
        hiddenInput.value = nomeFile;
        document.querySelector('form').appendChild(hiddenInput);
    }
    
    // Gestione allegati
    document.getElementById('allegati').addEventListener('change', function(e) {
        const files = e.target.files;
        const preview = document.getElementById('allegati-list');
        preview.innerHTML = '';
        
        Array.from(files).forEach((file, index) => {
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert(`Il file "${file.name}" supera i 5MB consentiti.`);
                return;
            }
            
            const item = document.createElement('div');
            item.className = 'allegato-item';
            item.innerHTML = `
                <span>üìé</span>
                <span class="allegato-nome">${file.name}</span>
                <span class="allegato-size">${(file.size / 1024).toFixed(1)} KB</span>
                <button type="button" class="remove-allegato" onclick="rimuoviAllegato(${index}, this)">√ó</button>
            `;
            preview.appendChild(item);
        });
    });
    
    function rimuoviAllegato(index, button) {
        const fileInput = document.getElementById('allegati');
        const dt = new DataTransfer();
        
        Array.from(fileInput.files).forEach((file, i) => {
            if (i !== index) dt.items.add(file);
        });
        
        fileInput.files = dt.files;
        button.parentElement.remove();
    }

    // Inizializza autocompletamento al caricamento
    document.addEventListener('DOMContentLoaded', function() {
        const fornitoreInput = document.getElementById('fornitore_nome');
        if (fornitoreInput && window.AutocompleteHelpers) {
            // Salva il valore originale prima di inizializzare l'autocompletamento
            const originalValue = fornitoreInput.value;
            
            const autocomplete = window.AutocompleteHelpers.setupFornitoriAutocomplete(fornitoreInput, {
                onSelect: function(item) {
                    document.getElementById('fornitore_id').value = item.id;
                    document.getElementById('fornitore_nome').value = item.ragione_sociale;
                }
            });
            
            // Ripristina il valore originale se era presente (modalit√† modifica)
            if (originalValue) {
                fornitoreInput.value = originalValue;
            }
        }
    });
        // Modal rifiuto offerta
        function mostraModalRifiuto(tipo, id) {
            const modal = document.getElementById('modal-rifiuto');
            const titoloModal = document.getElementById('titolo-modal-rifiuto');
            
            titoloModal.textContent = `Rifiuta ${tipo}`;
            modal.dataset.tipo = tipo;
            modal.dataset.id = id;
            modal.style.display = 'block';
        }
        
        function chiudiModalRifiuto() {
            document.getElementById('modal-rifiuto').style.display = 'none';
            document.getElementById('motivo-rifiuto').value = '';
        }
        
        function confermaRifiuto() {
            const modal = document.getElementById('modal-rifiuto');
            const tipo = modal.dataset.tipo;
            const id = modal.dataset.id;
            const motivo = document.getElementById('motivo-rifiuto').value;
            
            const formData = new FormData();
            formData.append('motivo', motivo);
            
            fetch(`/${tipo === 'offerta' ? 'offerte' : 'preventivi'}/${id}/rifiuta`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        location.reload();
                    }
                } else {
                    alert('Errore: ' + (data.errore || 'Errore sconosciuto'));
                }
                chiudiModalRifiuto();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Errore di rete: ' + error.message);
                chiudiModalRifiuto();
            });
        }
        
        // Modal cambio stato
        function mostraModalCambioStato() {
            const selectStato = document.getElementById('cambio-stato');
            const nuovoStato = selectStato.value;
            
            if (!nuovoStato) {
                alert('Seleziona un nuovo stato');
                return;
            }
            
            const modal = document.getElementById('modal-cambio-stato');
            const titoloModal = document.getElementById('titolo-modal-cambio-stato');
            const testoModal = document.getElementById('testo-modal-cambio-stato');
            
            const stati = {
                'creata': 'üìù Creata',
                'richiesta': 'üìß Richiesta', 
                'valutata': 'üîç In Valutazione',
                'accettata': '‚úÖ Accettata',
                'rifiutata': '‚ùå Rifiutata'
            };
            
            titoloModal.textContent = `Cambia Stato in ${stati[nuovoStato]}`;
            testoModal.textContent = `Sei sicuro di voler cambiare lo stato dell'offerta in "${stati[nuovoStato]}"?`;
            
            modal.dataset.stato = nuovoStato;
            modal.style.display = 'block';
        }
        
        function chiudiModalCambioStato() {
            document.getElementById('modal-cambio-stato').style.display = 'none';
            document.getElementById('motivo-cambio-stato').value = '';
            document.getElementById('cambio-stato').value = '';
        }
        
        function confermaCambioStato() {
            const modal = document.getElementById('modal-cambio-stato');
            const nuovoStato = modal.dataset.stato;
            const motivo = document.getElementById('motivo-cambio-stato').value;
            
            const formData = new FormData();
            formData.append('stato', nuovoStato);
            formData.append('motivo', motivo);
            
            {% if modalita == 'modifica' %}
            fetch(`/offerte/{{ offerta.id }}/cambia-stato`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        location.reload();
                    }
                } else {
                    alert('Errore: ' + (data.errore || 'Errore sconosciuto'));
                }
                chiudiModalCambioStato();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Errore di rete: ' + error.message);
                chiudiModalCambioStato();
            });
            {% endif %}
        }
        
        // Chiudi modal cliccando fuori
        window.onclick = function(event) {
            const modalRifiuto = document.getElementById('modal-rifiuto');
            const modalCambioStato = document.getElementById('modal-cambio-stato');
            
            if (event.target == modalRifiuto) {
                chiudiModalRifiuto();
            }
            if (event.target == modalCambioStato) {
                chiudiModalCambioStato();
            }
        }
    </script>

    <!-- Modal Rifiuto -->
    <div id="modal-rifiuto" class="modal-rifiuto" style="display: none;">
        <div class="modal-rifiuto-content">
            <div class="modal-rifiuto-header">
                <h2 id="titolo-modal-rifiuto">Rifiuta Offerta</h2>
                <span class="close-rifiuto" onclick="chiudiModalRifiuto()">&times;</span>
            </div>
            
            <div class="modal-rifiuto-body">
                <div class="form-group-rifiuto">
                    <label for="motivo-rifiuto">Motivo del rifiuto (opzionale):</label>
                    <textarea id="motivo-rifiuto" placeholder="Inserisci il motivo del rifiuto..." rows="4"></textarea>
                </div>
            </div>
            
            <div class="modal-rifiuto-footer">
                <button class="btn btn-secondary" onclick="chiudiModalRifiuto()">‚ùå Annulla</button>
                <button class="btn btn-danger" onclick="confermaRifiuto()">‚úÖ Conferma Rifiuto</button>
            </div>
        </div>
    </div>

    <!-- Modal Cambio Stato -->
    <div id="modal-cambio-stato" class="modal-rifiuto" style="display: none;">
        <div class="modal-rifiuto-content">
            <div class="modal-rifiuto-header">
                <h2 id="titolo-modal-cambio-stato">Cambia Stato</h2>
                <span class="close-rifiuto" onclick="chiudiModalCambioStato()">&times;</span>
            </div>
            
            <div class="modal-rifiuto-body">
                <p id="testo-modal-cambio-stato" style="margin-bottom: 15px; font-weight: 500;"></p>
                <div class="form-group-rifiuto">
                    <label for="motivo-cambio-stato">Motivo/Note (opzionale):</label>
                    <textarea id="motivo-cambio-stato" placeholder="Inserisci eventuali note sul cambio di stato..." rows="3"></textarea>
                </div>
            </div>
            
            <div class="modal-rifiuto-footer">
                <button class="btn btn-secondary" onclick="chiudiModalCambioStato()">‚ùå Annulla</button>
                <button class="btn btn-primary" onclick="confermaCambioStato()">‚úÖ Conferma Cambio</button>
            </div>
        </div>
    </div>

    <style>
        .modal-rifiuto {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-rifiuto-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 0;
            border: none;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .modal-rifiuto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        
        .modal-rifiuto-header h2 {
            margin: 0;
            color: #dc3545;
        }
        
        .close-rifiuto {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-rifiuto:hover {
            color: #000;
        }
        
        .modal-rifiuto-body {
            padding: 20px;
        }
        
        .form-group-rifiuto {
            margin-bottom: 15px;
        }
        
        .form-group-rifiuto label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group-rifiuto textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }
        
        .modal-rifiuto-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            text-align: right;
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
        }
        
        .modal-rifiuto-footer .btn {
            margin-left: 10px;
        }
    </style>
</body>
</html>