<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuova Richiesta Offerta a Fornitore - Sistema DDT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=4">
    <script src="{{ url_for('static', filename='autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='autocompletamento.js') }}"></script>
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="/">üè† Dashboard</a></li>
                <li><a href="/ddt-in">üì• DDT IN</a></li>
                <li><a href="/ddt-out">üì§ DDT OUT</a></li>
                <li><a href="/offerte" class="active">üí∞ Offerte</a></li>
                <li><a href="/preventivi">üìã Preventivi</a></li>
                <li><a href="/catalogo">üìö Catalogo</a></li>
            </ul>
        </nav>

        <div class="ddt-header">
            <h1>üí∞ Nuova Richiesta Offerta a Fornitore</h1>
            <p style="color: #8492a6; margin-top: 8px;">Registra una nuova richiesta di offerta da inviare a un fornitore</p>
        </div>

        <form method="POST" class="form-container">
            <!-- Dati testata offerta -->
            <div class="card">
                <h3>üì® Informazioni Generali</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fornitore_nome">Fornitore *</label>
                        <input type="text" id="fornitore_nome" name="fornitore_nome" placeholder="Digita per cercare fornitore..." required>
                        <input type="hidden" id="fornitore_id" name="fornitore_id">
                    </div>
                    
                    <div class="form-group">
                        <label for="oggetto">Oggetto *</label>
                        <input type="text" id="oggetto" name="oggetto" required
                               placeholder="Descrizione offerta">
                    </div>
                    
                    <div class="form-group">
                        <label for="data_offerta">Data Richiesta Offerta</label>
                        <input type="date" id="data_offerta" name="data_offerta" value="{{ today|default('') }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="data_scadenza">Data Scadenza</label>
                        <input type="date" id="data_scadenza" name="data_scadenza">
                    </div>
                    
                    <div class="form-group">
                        <label for="priorita">Priorit√†</label>
                        <select id="priorita" name="priorita">
                            <option value="bassa">üü¢ Bassa</option>
                            <option value="media" selected>üü° Media</option>
                            <option value="alta">üî¥ Alta</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="iva">IVA (%)</label>
                        <input type="number" id="iva" name="iva" value="22" min="0" max="100" step="0.01">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="note">Note</label>
                    <textarea id="note" name="note" rows="3" placeholder="Note sull'offerta..."></textarea>
                </div>
            </div>

            <!-- Dettagli offerta -->
            <div class="card">
                <h3>üì¶ Dettagli Offerta</h3>
                <div id="dettagli-container">
                    <div class="dettaglio-row" data-index="0">
                        <div class="form-grid dettaglio-grid">
                            <div class="form-group">
                                <label>Cod. Interno</label>
                                <input type="text" name="dettagli[0][codice]" placeholder="Codice...">
                            </div>
                            <div class="form-group">
                                <label>Cod. Fornitore</label>
                                <input type="text" name="dettagli[0][codice_fornitore]" placeholder="Codice fornitore...">
                            </div>
                            <div class="form-group" style="position: relative;">
                                <label>Descrizione *</label>
                                <input type="text" name="dettagli[0][descrizione]" required placeholder="Descrizione articolo..." 
                                       oninput="cercaArticoloOfferta(this, 0)" autocomplete="off">
                                <div class="autocomplete-results" id="articolo-results-0"></div>
                            </div>
                            <div class="form-group">
                                <label>Quantit√† *</label>
                                <input type="number" name="dettagli[0][quantita]" value="1" min="0.01" step="0.01" required 
                                       onchange="calcolaTotaleRiga(0)">
                            </div>
                            <div class="form-group">
                                <label>U.M.</label>
                                <select name="dettagli[0][unita]">
                                    <option value="PZ">PZ</option>
                                    <option value="KG">KG</option>
                                    <option value="MT">MT</option>
                                    <option value="MQ">MQ</option>
                                    <option value="MC">MC</option>
                                    <option value="LT">LT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Prezzo Unit.</label>
                                <input type="number" name="dettagli[0][prezzo_unitario]" min="0" step="0.01"
                                       placeholder="0.00" onchange="calcolaTotaleRiga(0)">
                            </div>
                            <div class="form-group">
                                <label>Sconto %</label>
                                <input type="number" name="dettagli[0][sconto]" min="0" max="100" step="0.01" value="0"
                                       onchange="calcolaTotaleRiga(0)">
                            </div>
                            <div class="form-group">
                                <label>Disponibilit√†</label>
                                <input type="text" name="dettagli[0][disponibilita]" placeholder="Es: In stock">
                            </div>
                            <div class="form-group">
                                <label>Tempi Consegna</label>
                                <input type="text" name="dettagli[0][consegna]" placeholder="Es: 15gg">
                            </div>
                            <div class="form-group">
                                <label>Totale Riga</label>
                                <input type="number" class="totale-riga" readonly placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-danger btn-sm" onclick="rimuoviDettaglio(0)">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <button type="button" class="btn btn-secondary" onclick="aggiungiDettaglio()">+ Aggiungi Riga</button>
                </div>
            </div>

            <!-- Riepilogo totali -->
            <div class="card">
                <h3>üí∞ Riepilogo Totali</h3>
                <div class="totali-grid">
                    <div class="totale-item">
                        <label>Totale Netto:</label>
                        <span id="totale-netto">‚Ç¨ 0.00</span>
                    </div>
                    <div class="totale-item">
                        <label>IVA:</label>
                        <span id="totale-iva">‚Ç¨ 0.00</span>
                    </div>
                    <div class="totale-item totale-finale">
                        <label>Totale Lordo:</label>
                        <span id="totale-lordo">‚Ç¨ 0.00</span>
                    </div>
                </div>
            </div>

            <!-- Pulsanti azione -->
            <div class="form-actions">
                <a href="/offerte" class="btn btn-secondary">‚¨ÖÔ∏è Annulla</a>
                <button type="submit" class="btn btn-success">üíæ Salva Offerta</button>
            </div>
        </form>
    </div>

    <style>
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .autocomplete-results.show {
            display: block;
        }
        
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .autocomplete-item:hover {
            background-color: #f0f0f0;
        }
    </style>

    <script>
        let dettaglioIndex = 1;

        function updateFornitoreNome() {
            const select = document.getElementById('fornitore_id');
            const hiddenInput = document.getElementById('fornitore_nome');
            const selectedOption = select.options[select.selectedIndex];
            hiddenInput.value = selectedOption.getAttribute('data-nome') || '';
        }

        function aggiungiDettaglio() {
            const container = document.getElementById('dettagli-container');
            const newRow = document.createElement('div');
            newRow.className = 'dettaglio-row';
            newRow.setAttribute('data-index', dettaglioIndex);
            
            newRow.innerHTML = `
                <div class="form-grid dettaglio-grid">
                    <div class="form-group">
                        <label>Cod. Interno</label>
                        <input type="text" name="dettagli[${dettaglioIndex}][codice]" placeholder="Codice...">
                    </div>
                    <div class="form-group">
                        <label>Cod. Fornitore</label>
                        <input type="text" name="dettagli[${dettaglioIndex}][codice_fornitore]" placeholder="Codice fornitore...">
                    </div>
                    <div class="form-group" style="position: relative;">
                        <label>Descrizione *</label>
                        <input type="text" name="dettagli[${dettaglioIndex}][descrizione]" required placeholder="Descrizione articolo..." 
                               oninput="cercaArticoloOfferta(this, ${dettaglioIndex})" autocomplete="off">
                        <div class="autocomplete-results" id="articolo-results-${dettaglioIndex}"></div>
                    </div>
                    <div class="form-group">
                        <label>Quantit√† *</label>
                        <input type="number" name="dettagli[${dettaglioIndex}][quantita]" value="1" min="0.01" step="0.01" required 
                               onchange="calcolaTotaleRiga(${dettaglioIndex})">
                    </div>
                    <div class="form-group">
                        <label>U.M.</label>
                        <select name="dettagli[${dettaglioIndex}][unita]">
                            <option value="PZ">PZ</option>
                            <option value="KG">KG</option>
                            <option value="MT">MT</option>
                            <option value="MQ">MQ</option>
                            <option value="MC">MC</option>
                            <option value="LT">LT</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Prezzo Unit.</label>
                        <input type="number" name="dettagli[${dettaglioIndex}][prezzo_unitario]" min="0" step="0.01"
                               placeholder="0.00" onchange="calcolaTotaleRiga(${dettaglioIndex})">
                    </div>
                    <div class="form-group">
                        <label>Sconto %</label>
                        <input type="number" name="dettagli[${dettaglioIndex}][sconto]" min="0" max="100" step="0.01" value="0"
                               onchange="calcolaTotaleRiga(${dettaglioIndex})">
                    </div>
                    <div class="form-group">
                        <label>Disponibilit√†</label>
                        <input type="text" name="dettagli[${dettaglioIndex}][disponibilita]" placeholder="Es: In stock">
                    </div>
                    <div class="form-group">
                        <label>Tempi Consegna</label>
                        <input type="text" name="dettagli[${dettaglioIndex}][consegna]" placeholder="Es: 15gg">
                    </div>
                    <div class="form-group">
                        <label>Totale Riga</label>
                        <input type="number" class="totale-riga" readonly placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-danger btn-sm" onclick="rimuoviDettaglio(${dettaglioIndex})">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            
            container.appendChild(newRow);
            dettaglioIndex++;
            
            // Notifica che √® stata aggiunta una nuova riga per autocompletamento
            const event = new CustomEvent('nuovaRigaAggiunta', {
                detail: { riga: newRow }
            });
            document.dispatchEvent(event);
        }

        function rimuoviDettaglio(index) {
            const row = document.querySelector(`[data-index="${index}"]`);
            if (row && document.querySelectorAll('.dettaglio-row').length > 1) {
                row.remove();
                calcolaTotaliGenerali();
            }
        }

        function calcolaTotaleRiga(index) {
            const row = document.querySelector(`[data-index="${index}"]`);
            if (!row) return;
            
            const quantita = parseFloat(row.querySelector('[name*="[quantita]"]').value) || 0;
            const prezzo = parseFloat(row.querySelector('[name*="[prezzo_unitario]"]').value) || 0;
            const sconto = parseFloat(row.querySelector('[name*="[sconto]"]').value) || 0;
            
            const totaleRiga = quantita * prezzo * (1 - sconto/100);
            row.querySelector('.totale-riga').value = totaleRiga.toFixed(2);
            
            calcolaTotaliGenerali();
        }

        function calcolaTotaliGenerali() {
            const righe = document.querySelectorAll('.totale-riga');
            let totaleNetto = 0;
            
            righe.forEach(riga => {
                totaleNetto += parseFloat(riga.value) || 0;
            });
            
            const ivaPercentuale = parseFloat(document.getElementById('iva').value) || 0;
            const totaleIva = totaleNetto * ivaPercentuale / 100;
            const totaleLordo = totaleNetto + totaleIva;
            
            document.getElementById('totale-netto').textContent = `‚Ç¨ ${totaleNetto.toFixed(2)}`;
            document.getElementById('totale-iva').textContent = `‚Ç¨ ${totaleIva.toFixed(2)}`;
            document.getElementById('totale-lordo').textContent = `‚Ç¨ ${totaleLordo.toFixed(2)}`;
        }

        // Ricalcola totali quando cambia l'IVA
        document.getElementById('iva').addEventListener('change', calcolaTotaliGenerali);

        // Funzione per autocompletamento articoli
        function cercaArticoloOfferta(input, index) {
            const query = input.value;
            const resultsDiv = document.getElementById(`articolo-results-${index}`);
            
            if (query.length < 2) {
                resultsDiv.innerHTML = '';
                resultsDiv.classList.remove('show');
                return;
            }

            fetch(`/api/articoli/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    resultsDiv.innerHTML = '';
                    
                    if (data.length === 0) {
                        resultsDiv.classList.remove('show');
                        return;
                    }
                    
                    data.forEach(articolo => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-item';
                        div.textContent = `${articolo.codice_interno} - ${articolo.descrizione}`;
                        div.onclick = function() {
                            input.value = articolo.descrizione;
                            // Imposta anche il codice se c'√® un campo per quello
                            const codiceInput = input.closest('.dettaglio-row').querySelector('[name*="[codice]"]');
                            if (codiceInput) {
                                codiceInput.value = articolo.codice_interno;
                            }
                            resultsDiv.innerHTML = '';
                            resultsDiv.classList.remove('show');
                        };
                        resultsDiv.appendChild(div);
                    });
                    
                    resultsDiv.classList.add('show');
                })
                .catch(error => {
                    console.error('Errore ricerca articoli:', error);
                    resultsDiv.classList.remove('show');
                });
        }
    </script>

    <style>
        .dettaglio-grid {
            grid-template-columns: 100px 120px 2fr 80px 60px 100px 80px 100px 100px 100px 50px;
            gap: 8px;
            align-items: end;
        }
        
        .dettaglio-row {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .totali-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .totale-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .totale-finale {
            background: #e8f5e8;
            font-weight: 600;
            font-size: 1.1em;
        }
    </style>
    
    <script>
    // Funzione per aggiornare fornitore
    function updateFornitore(id, nome) {
        document.getElementById('fornitore_id').value = id;
        document.getElementById('fornitore_nome').value = nome;
    }
    
    // Inizializza autocompletamento al caricamento
    document.addEventListener('DOMContentLoaded', function() {
        const fornitoreInput = document.getElementById('fornitore_nome');
        if (fornitoreInput && window.AutocompleteHelpers) {
            window.AutocompleteHelpers.setupFornitoriAutocomplete(fornitoreInput);
        }
    });
    </script>
</body>
</html>