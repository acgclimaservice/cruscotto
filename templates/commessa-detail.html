<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commessa {{ commessa.numero_progressivo }} - Sistema Gestione DDT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="/">üè† Dashboard</a></li>
                <li><a href="/ddt-in">üì• DDT IN</a></li>
                <li><a href="/ddt-out">üì§ DDT OUT</a></li>
                <li><a href="/offerte">üí∞ Offerte</a></li>
                <li><a href="/preventivi">üìã Preventivi</a></li>
                <li><a href="/catalogo">üìö Catalogo</a></li>
                <li><a href="/movimenti">üìä Movimenti</a></li>
                <li><a href="/movimenti-interni">üîÑ Movimenti Interni</a></li>
                <li><a href="/inventario">üì¶ Inventario</a></li>
                <li><a href="/commesse" class="active">üèóÔ∏è Commesse</a></li>
                <li><a href="/clienti">üë• Clienti</a></li>
                <li><a href="/fornitori">üè≠ Fornitori</a></li>
                <li><a href="/impostazioni">‚öôÔ∏è Impostazioni</a></li>
            </ul>
        </nav>

        <div class="ddt-header">
            <h1>üèóÔ∏è Commessa {{ commessa.numero_progressivo }}</h1>
            <div class="actions">
                <a href="/commesse" class="btn btn-secondary">‚Üê Torna alle Commesse</a>
                {% if commessa.stato == 'aperta' %}
                <button class="btn btn-danger" onclick="chiudiCommessa({{ commessa.id }})">Chiudi Commessa</button>
                {% endif %}
            </div>
        </div>

        <!-- Informazioni Generali -->
        <div class="card-detail">
            <div class="card-header">
                <h3>üìã Informazioni Generali</h3>
                <span class="status {{ 'confirmed' if commessa.stato == 'aperta' else 'draft' }}">
                    {{ commessa.stato|upper }}
                </span>
            </div>
            <div class="card-body">
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Cliente</label>
                        <value>{{ commessa.cliente_nome }}</value>
                    </div>
                    <div class="detail-item">
                        <label>Tipologia</label>
                        <value>
                            <span class="badge badge-{{ commessa.tipologia|lower|replace(' ', '-') }}">
                                {{ commessa.tipologia }}
                            </span>
                        </value>
                    </div>
                    <div class="detail-item">
                        <label>Data Apertura</label>
                        <value>{{ commessa.data_apertura.strftime('%d/%m/%Y') if commessa.data_apertura else '-' }}</value>
                    </div>
                    <div class="detail-item">
                        <label>Data Scadenza</label>
                        <value>{{ commessa.data_scadenza.strftime('%d/%m/%Y') if commessa.data_scadenza else '-' }}</value>
                    </div>
                    {% if commessa.data_chiusura %}
                    <div class="detail-item">
                        <label>Data Chiusura</label>
                        <value>{{ commessa.data_chiusura.strftime('%d/%m/%Y') }}</value>
                    </div>
                    {% endif %}
                </div>
                
                {% if commessa.descrizione %}
                <div class="detail-item full-width">
                    <label>Descrizione</label>
                    <value>{{ commessa.descrizione }}</value>
                </div>
                {% endif %}
                
                {% if commessa.note %}
                <div class="detail-item full-width">
                    <label>Note</label>
                    <value>{{ commessa.note }}</value>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- DDT Collegati -->
        <div class="card-detail">
            <div class="card-header">
                <h3>üì¶ DDT Collegati</h3>
                <span class="count-badge">{{ ddt_collegati|length }}</span>
            </div>
            <div class="card-body">
                {% if ddt_collegati %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Numero DDT</th>
                                <th>Data</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ddt in ddt_collegati %}
                            <tr>
                                <td>
                                    <span class="badge {{ 'badge-in' if ddt.tipo == 'IN' else 'badge-out' }}">
                                        {{ ddt.tipo }}
                                    </span>
                                </td>
                                <td><strong>{{ ddt.numero_ddt }}</strong></td>
                                <td>{{ ddt.data_documento.strftime('%d/%m/%Y') if ddt.data_documento else '-' }}</td>
                                <td>
                                    <span class="status {{ 'confirmed' if ddt.stato == 'confermato' else 'draft' }}">
                                        {{ ddt.stato|upper }}
                                    </span>
                                </td>
                                <td class="actions">
                                    {% if ddt.tipo == 'IN' %}
                                    <a href="/ddt-in/{{ ddt.id }}" class="btn btn-sm">Visualizza</a>
                                    {% else %}
                                    <a href="/ddt-out/{{ ddt.id }}" class="btn btn-sm">Visualizza</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div style="text-align: center; padding: 40px; color: #888;">
                    Nessun DDT collegato a questa commessa
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Preventivi Collegati -->
        <div class="card-detail">
            <div class="card-header">
                <h3>üìã Preventivi Collegati</h3>
                <span class="count-badge">{{ preventivi_collegati|length }}</span>
            </div>
            <div class="card-body">
                {% if preventivi_collegati %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Numero</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th>Stato</th>
                                <th>Totale</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for preventivo in preventivi_collegati %}
                            <tr>
                                <td><strong>{{ preventivo.numero_preventivo }}</strong></td>
                                <td>{{ preventivo.cliente_nome }}</td>
                                <td>{{ preventivo.data_preventivo.strftime('%d/%m/%Y') if preventivo.data_preventivo else '-' }}</td>
                                <td>
                                    <span class="status {{ 'confirmed' if preventivo.stato == 'accettato' else 'draft' }}">
                                        {{ preventivo.stato|upper }}
                                    </span>
                                </td>
                                <td>‚Ç¨ {{ "{:,.2f}".format(preventivo.totale_lordo or 0) }}</td>
                                <td class="actions">
                                    <a href="/preventivi/{{ preventivo.id }}" class="btn btn-sm">Visualizza</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div style="text-align: center; padding: 40px; color: #888;">
                    Nessun preventivo collegato a questa commessa
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Ordini Collegati -->
        <div class="card-detail">
            <div class="card-header">
                <h3>üì¶ Ordini Collegati</h3>
                <span class="count-badge">{{ ordini_collegati|length }}</span>
            </div>
            <div class="card-body">
                {% if ordini_collegati %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Numero</th>
                                <th>Fornitore</th>
                                <th>Data</th>
                                <th>Stato</th>
                                <th>Priorit√†</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ordine in ordini_collegati %}
                            <tr>
                                <td><strong>{{ ordine.numero_ordine }}</strong></td>
                                <td>{{ ordine.fornitore_nome }}</td>
                                <td>{{ ordine.data_ordine.strftime('%d/%m/%Y') if ordine.data_ordine else '-' }}</td>
                                <td>
                                    <span class="status {{ 'confirmed' if ordine.stato == 'completato' else 'draft' }}">
                                        {{ ordine.stato|upper }}
                                    </span>
                                </td>
                                <td>
                                    <span class="priority-badge {{ ordine.priorita }}">
                                        {% if ordine.priorita == 'alta' %}üî¥ Alta{% elif ordine.priorita == 'media' %}üü° Media{% else %}üü¢ Bassa{% endif %}
                                    </span>
                                </td>
                                <td class="actions">
                                    <a href="/ordini/{{ ordine.id }}" class="btn btn-sm">Visualizza</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div style="text-align: center; padding: 40px; color: #888;">
                    Nessun ordine collegato a questa commessa
                </div>
                {% endif %}
            </div>
        </div>

        <!-- MPLS Collegati -->
        <div class="card-detail">
            <div class="card-header">
                <h3>üíº MPLS Collegati</h3>
                <span class="count-badge">{{ mpls_collegati|length }}</span>
            </div>
            <div class="card-body">
                {% if mpls_collegati %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Numero MPLS</th>
                                <th>Cliente</th>
                                <th>Descrizione</th>
                                <th>Data Creazione</th>
                                <th>Totale Costo</th>
                                <th>Totale Vendita</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mpls in mpls_collegati %}
                            <tr>
                                <td><strong>{{ mpls.numero_mpls }}</strong></td>
                                <td>{{ mpls.cliente_nome or '-' }}</td>
                                <td>{{ mpls.descrizione or '-' }}</td>
                                <td>{{ mpls.data_creazione.strftime('%d/%m/%Y') if mpls.data_creazione else '-' }}</td>
                                <td>‚Ç¨ {{ "%.2f"|format(mpls.totale_costo_materiali or 0) }}</td>
                                <td>‚Ç¨ {{ "%.2f"|format(mpls.totale_vendita_materiali or 0) }}</td>
                                <td>
                                    <a href="/mpls/{{ mpls.id }}" class="btn btn-sm">Visualizza</a>
                                    <a href="/mpls/{{ mpls.id }}/modifica" class="btn btn-sm btn-secondary">Modifica</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    Nessun MPLS collegato a questa commessa
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Offerte Fornitori Collegate -->
        <div class="card-detail">
            <div class="card-header">
                <h3>üí∞ Offerte Fornitori Collegate</h3>
                <span class="count-badge">{{ offerte_collegate|length }}</span>
            </div>
            <div class="card-body">
                {% if offerte_collegate %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Numero Offerta</th>
                                <th>Fornitore</th>
                                <th>Oggetto</th>
                                <th>Stato</th>
                                <th>Data Ricevuta</th>
                                <th>Totale</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for offerta in offerte_collegate %}
                            <tr>
                                <td><strong>{{ offerta.numero_offerta or 'BOZZA #' + offerta.id|string }}</strong></td>
                                <td>{{ offerta.fornitore_nome or '-' }}</td>
                                <td>{{ offerta.oggetto or '-' }}</td>
                                <td>
                                    <span class="status {{ 'confirmed' if offerta.stato == 'accettata' else ('draft' if offerta.stato == 'creata' else 'pending') }}">
                                        {{ offerta.stato|upper }}
                                    </span>
                                </td>
                                <td>{{ offerta.data_ricevuta.strftime('%d/%m/%Y') if offerta.data_ricevuta else '-' }}</td>
                                <td>‚Ç¨ {{ "%.2f"|format(offerta.totale_netto or 0) }}</td>
                                <td>
                                    <a href="/offerte/{{ offerta.id }}" class="btn btn-sm">Visualizza</a>
                                    <a href="/offerte/{{ offerta.id }}/modifica" class="btn btn-sm btn-secondary">Modifica</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    Nessuna offerta fornitore collegata a questa commessa
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Statistiche -->
        <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-top: 30px;">
            <div class="stat-card">
                <h3>{{ ddt_collegati|length }}</h3>
                <p>DDT Totali</p>
            </div>
            <div class="stat-card">
                <h3 style="color: #059669;">{{ ddt_collegati|selectattr('tipo', 'equalto', 'IN')|list|length }}</h3>
                <p>DDT IN</p>
            </div>
            <div class="stat-card">
                <h3 style="color: #dc2626;">{{ ddt_collegati|selectattr('tipo', 'equalto', 'OUT')|list|length }}</h3>
                <p>DDT OUT</p>
            </div>
        </div>
    </div>

    <!-- Sezione Allegati -->
    <div class="card-detail">
        <div class="card-header">
            <h3>üìé Allegati Esterni</h3>
            <div style="display: flex; gap: 10px;">
                <span class="count-badge">{{ allegati|length }}</span>
                {% if commessa.stato == 'aperta' %}
                <button class="btn btn-success btn-sm" onclick="showUploadModal()">üìÅ Carica Allegato</button>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            {% if allegati %}
            <div class="allegati-grid">
                {% for allegato in allegati %}
                <div class="allegato-item">
                    <div class="allegato-icon">
                        {% if allegato.tipo_file in ['pdf'] %}
                            üìÑ
                        {% elif allegato.tipo_file in ['jpg', 'jpeg', 'png', 'gif'] %}
                            üñºÔ∏è
                        {% elif allegato.tipo_file in ['doc', 'docx'] %}
                            üìù
                        {% elif allegato.tipo_file in ['xls', 'xlsx'] %}
                            üìä
                        {% elif allegato.tipo_file in ['zip', 'rar'] %}
                            üóúÔ∏è
                        {% else %}
                            üìé
                        {% endif %}
                    </div>
                    <div class="allegato-info">
                        <div class="allegato-nome">{{ allegato.nome_file_originale }}</div>
                        <div class="allegato-details">
                            <span class="allegato-data">{{ allegato.data_caricamento.strftime('%d/%m/%Y %H:%M') }}</span>
                            <span class="allegato-size">{{ allegato.get_dimensione_readable() }}</span>
                        </div>
                        {% if allegato.descrizione %}
                        <div class="allegato-descrizione">{{ allegato.descrizione }}</div>
                        {% endif %}
                    </div>
                    <div class="allegato-actions">
                        <a href="/commesse/{{ commessa.id }}/allegati/{{ allegato.id }}/download" 
                           class="btn btn-sm btn-primary" title="Scarica">‚¨áÔ∏è</a>
                        {% if commessa.stato == 'aperta' %}
                        <button class="btn btn-sm btn-danger" 
                                onclick="eliminaAllegato({{ allegato.id }})" title="Elimina">üóëÔ∏è</button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px; color: #888;">
                <div style="font-size: 48px; margin-bottom: 15px;">üìé</div>
                <div>Nessun allegato caricato</div>
                {% if commessa.stato == 'aperta' %}
                <button class="btn btn-success" onclick="showUploadModal()" style="margin-top: 15px;">üìÅ Carica Primo Allegato</button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal Upload Allegato -->
    <div id="uploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÅ Carica Allegato</h3>
                <span class="modal-close" onclick="hideUploadModal()">&times;</span>
            </div>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="allegato_file">Seleziona File:</label>
                        <input type="file" id="allegato_file" name="allegato_file" required
                               accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.xls,.xlsx,.txt,.zip,.rar">
                        <small>Tipi supportati: PDF, DOC, DOCX, JPG, PNG, XLS, XLSX, TXT, ZIP, RAR</small>
                    </div>
                    <div class="form-group">
                        <label for="descrizione">Descrizione (opzionale):</label>
                        <textarea id="descrizione" name="descrizione" rows="3" 
                                  placeholder="Descrivi brevemente il contenuto del file..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="hideUploadModal()" class="btn btn-secondary">Annulla</button>
                    <button type="submit" class="btn btn-success">üìÅ Carica Allegato</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    function chiudiCommessa(id) {
        if (confirm('Sei sicuro di voler chiudere questa commessa?')) {
            fetch(`/commesse/${id}/chiudi`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Commessa chiusa con successo');
                    location.reload();
                } else {
                    alert('Errore: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Errore durante la chiusura della commessa');
            });
        }
    }

    // Funzioni per gestione allegati
    function showUploadModal() {
        document.getElementById('uploadModal').style.display = 'block';
    }

    function hideUploadModal() {
        document.getElementById('uploadModal').style.display = 'none';
        document.getElementById('uploadForm').reset();
    }

    // Upload allegato
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '‚è≥ Caricamento...';
        
        fetch(`/commesse/{{ commessa.id }}/allegati/upload`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Allegato caricato con successo!');
                hideUploadModal();
                location.reload();
            } else {
                alert('Errore: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Errore durante il caricamento del file');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });

    // Elimina allegato
    function eliminaAllegato(allegatoId) {
        if (confirm('Sei sicuro di voler eliminare questo allegato?')) {
            fetch(`/commesse/{{ commessa.id }}/allegati/${allegatoId}/elimina`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Allegato eliminato con successo');
                    location.reload();
                } else {
                    alert('Errore: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Errore durante l\'eliminazione dell\'allegato');
            });
        }
    }

    // Chiudi modal cliccando fuori
    window.onclick = function(event) {
        const modal = document.getElementById('uploadModal');
        if (event.target == modal) {
            hideUploadModal();
        }
    }
    </script>

    <style>
    .card-detail {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }

    .card-header {
        background: #f8fafc;
        padding: 20px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-header h3 {
        margin: 0;
        color: #1e293b;
    }

    .card-body {
        padding: 20px;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .detail-item.full-width {
        grid-column: 1 / -1;
    }

    .detail-item label {
        font-weight: 600;
        color: #64748b;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .detail-item value {
        color: #1e293b;
        font-weight: 500;
        line-height: 1.4;
    }

    .count-badge {
        background: #3b82f6;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.9em;
        font-weight: 600;
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
    }

    .badge-riqualificazione { background: #dbeafe; color: #1d4ed8; }
    .badge-manutenzione-ordinaria { background: #d1fae5; color: #065f46; }
    .badge-manutenzione-straordinaria { background: #fef3c7; color: #92400e; }
    .badge-in { background: #dcfce7; color: #166534; }
    .badge-out { background: #fee2e2; color: #dc2626; }

    /* Stili Allegati */
    .allegati-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
    }
    
    .allegato-item {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 15px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #f8fafc;
    }
    
    .allegato-icon {
        font-size: 24px;
        flex-shrink: 0;
    }
    
    .allegato-info {
        flex: 1;
        min-width: 0;
    }
    
    .allegato-nome {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 5px;
        word-break: break-all;
    }
    
    .allegato-details {
        font-size: 12px;
        color: #64748b;
        margin-bottom: 5px;
    }
    
    .allegato-details span {
        margin-right: 15px;
    }
    
    .allegato-descrizione {
        font-size: 13px;
        color: #475569;
        font-style: italic;
    }
    
    .allegato-actions {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    /* Stili Modal */
    .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h3 {
        margin: 0;
        color: #1e293b;
    }
    
    .modal-close {
        font-size: 24px;
        cursor: pointer;
        color: #64748b;
    }
    
    .modal-close:hover {
        color: #dc2626;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        padding: 20px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #374151;
    }
    
    .form-group input[type="file"],
    .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .form-group small {
        display: block;
        margin-top: 5px;
        color: #6b7280;
        font-size: 12px;
    }

    @media (max-width: 768px) {
        .detail-grid {
            grid-template-columns: 1fr;
        }
        
        .card-header {
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }
    }
    </style>
</body>
</html>